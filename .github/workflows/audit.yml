name: Audit Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: "0 4 * * *" # daily 04:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify docs
        run: npm run test:docs

      - name: Verify docs artifacts are generated and aligned
        run: npm run docs-artifacts:check

  drift-budgets:
    name: drift-budgets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify drift and budget guards
        run: npm run catchup:drift-check

  firestore-indexes:
    name: firestore-indexes
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate required index-check variables
        if: github.event_name != 'pull_request'
        run: |
          REQUIRED_VARS=(
            GCP_WIF_PROVIDER
            DEPLOY_SA_EMAIL
          )
          MISSING=0
          for VAR_NAME in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!VAR_NAME}" ]; then
              echo "::error title=Missing workflow variable::${VAR_NAME} is empty"
              MISSING=1
            fi
          done
          if [ -z "${FIRESTORE_PROJECT_ID}" ] && [ -z "${GCP_PROJECT_ID}" ]; then
            echo "::error title=Missing workflow variable::FIRESTORE_PROJECT_ID or GCP_PROJECT_ID must be set"
            MISSING=1
          fi
          if [ "$MISSING" -ne 0 ]; then
            exit 1
          fi

      - name: Auth (OIDC)
        if: github.event_name != 'pull_request'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.DEPLOY_SA_EMAIL }}
          token_format: access_token

      - name: Setup gcloud
        if: github.event_name != 'pull_request'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.FIRESTORE_PROJECT_ID || env.GCP_PROJECT_ID }}

      - name: Validate required Firestore critical contracts (PR-safe)
        if: github.event_name == 'pull_request'
        run: npm run firestore-indexes:check -- --contracts-only

      - name: Check required Firestore composite indexes
        if: github.event_name != 'pull_request'
        run: npm run firestore-indexes:check -- --project-id "${FIRESTORE_PROJECT_ID:-$GCP_PROJECT_ID}"

  audit-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run audit
        run: |
          chmod +x tools/audit/run_audit.sh
          tools/audit/run_audit.sh

      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-artifacts
          path: artifacts/audit

      - name: Upload Semgrep SARIF
        if: always() && hashFiles('artifacts/audit/semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: artifacts/audit/semgrep.sarif

  nav-contract:
    name: nav-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run admin nav contract tests
        run: npm run test:admin-nav-contract

  audit:
    runs-on: ubuntu-latest
    needs:
      - docs
      - drift-budgets
      - firestore-indexes
      - audit-run
      - nav-contract
    if: always()
    steps:
      - name: Aggregate required gate results
        run: |
          set -euo pipefail
          DOCS_RESULT="${{ needs.docs.result }}"
          DRIFT_BUDGETS_RESULT="${{ needs.drift-budgets.result }}"
          INDEX_RESULT="${{ needs.firestore-indexes.result }}"
          AUDIT_RUN_RESULT="${{ needs.audit-run.result }}"
          NAV_CONTRACT_RESULT="${{ needs.nav-contract.result }}"
          echo "docs=${DOCS_RESULT}"
          echo "drift-budgets=${DRIFT_BUDGETS_RESULT}"
          echo "firestore-indexes=${INDEX_RESULT}"
          echo "audit-run=${AUDIT_RUN_RESULT}"
          echo "nav-contract=${NAV_CONTRACT_RESULT}"
          if [ "${DOCS_RESULT}" != "success" ] || [ "${DRIFT_BUDGETS_RESULT}" != "success" ] || [ "${INDEX_RESULT}" != "success" ] || [ "${AUDIT_RUN_RESULT}" != "success" ] || [ "${NAV_CONTRACT_RESULT}" != "success" ]; then
            echo "::error title=Audit aggregate gate failed::At least one required upstream job failed or was skipped."
            exit 1
          fi
