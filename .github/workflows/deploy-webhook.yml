name: Deploy webhook service (Cloud Run)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Deploy target environment"
        required: true
        default: stg
        type: choice
        options:
          - stg
          - prod
      confirm_production:
        description: "Required when target_environment=prod (type: DEPLOY_PROD)"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  RUNTIME_SA_EMAIL: ${{ vars.RUNTIME_SA_EMAIL }}
  DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
  ENV_NAME: ${{ vars.ENV_NAME }}
  FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}

jobs:
  deploy-webhook:
    name: deploy-webhook
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' && 'prod' || 'stg' }}
    concurrency:
      group: deploy-webhook-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' && 'prod' || 'stg' }}
      cancel-in-progress: false
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.GCP_REGION }}
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      RUNTIME_SA_EMAIL: ${{ vars.RUNTIME_SA_EMAIL }}
      DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate production confirmation
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' }}
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY_PROD" ]; then
            echo "confirm_production must be DEPLOY_PROD when target_environment=prod"
            exit 1
          fi

      - name: Validate required deploy variables
        run: |
          REQUIRED_VARS=(
            GCP_PROJECT_ID
            GCP_REGION
            SERVICE_NAME
            GCP_WIF_PROVIDER
            RUNTIME_SA_EMAIL
            DEPLOY_SA_EMAIL
            ENV_NAME
            FIRESTORE_PROJECT_ID
          )
          MISSING=0
          for VAR_NAME in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!VAR_NAME}" ]; then
              echo "::error title=Missing workflow variable::${VAR_NAME} is empty"
              MISSING=1
            fi
          done
          if [ "$MISSING" -ne 0 ]; then
            exit 1
          fi

      - name: Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.DEPLOY_SA_EMAIL }}
          token_format: access_token

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Validate required secrets exist
        run: |
          REQUIRED_SECRETS=(
            LINE_CHANNEL_SECRET
            LINE_CHANNEL_ACCESS_TOKEN
            REDAC_MEMBERSHIP_ID_HMAC_SECRET
          )
          MISSING=0
          VISIBILITY_SKIPPED=0
          for SECRET_NAME in "${REQUIRED_SECRETS[@]}"; do
            DESCRIBE_OUTPUT=""
            if DESCRIBE_OUTPUT=$(gcloud secrets describe "$SECRET_NAME" \
              --project "$GCP_PROJECT_ID" \
              --format='value(name)' 2>&1); then
              echo "Secret found: ${SECRET_NAME}"
              continue
            fi

            if echo "$DESCRIBE_OUTPUT" | grep -qi "NOT_FOUND"; then
              echo "::error title=Missing Secret Manager secret::${SECRET_NAME} was not found in ${GCP_PROJECT_ID}"
              MISSING=1
              continue
            fi

            if echo "$DESCRIBE_OUTPUT" | grep -Eqi "PERMISSION_DENIED|does not have permission|secretmanager.secrets.get"; then
              echo "::warning title=Secret visibility skipped::${SECRET_NAME} metadata is not visible to deploy SA; existence check skipped."
              VISIBILITY_SKIPPED=1
              continue
            fi

            echo "::error title=Secret preflight failed::${SECRET_NAME} existence check failed unexpectedly"
            echo "$DESCRIBE_OUTPUT"
            MISSING=1
          done
          if [ "$VISIBILITY_SKIPPED" -ne 0 ]; then
            echo "::notice title=Secret preflight mode::Some secrets were not visibility-checked due to deploy SA permissions; deploy/runtime checks remain authoritative."
          fi
          if [ "$MISSING" -ne 0 ]; then
            exit 1
          fi

      - name: Ensure runtime SA can access required secrets
        run: |
          RUNTIME_MEMBER="serviceAccount:${RUNTIME_SA_EMAIL}"
          for SECRET_NAME in \
            LINE_CHANNEL_SECRET \
            LINE_CHANNEL_ACCESS_TOKEN \
            REDAC_MEMBERSHIP_ID_HMAC_SECRET
          do
            echo "Granting roles/secretmanager.secretAccessor on ${SECRET_NAME} to ${RUNTIME_MEMBER}"
            if gcloud secrets add-iam-policy-binding "$SECRET_NAME" \
              --project "$GCP_PROJECT_ID" \
              --member "$RUNTIME_MEMBER" \
              --role "roles/secretmanager.secretAccessor" \
              --quiet >/dev/null; then
              echo "Secret IAM updated: ${SECRET_NAME}"
            else
              echo "::warning title=Secret IAM update skipped::${SECRET_NAME} secret IAM update failed (insufficient permission or secret not found); continuing deploy."
            fi
          done

      - name: Build image (Cloud Build)
        run: |
          WEBHOOK_SERVICE_NAME="${SERVICE_NAME}-webhook"
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${WEBHOOK_SERVICE_NAME}:${GITHUB_SHA}"
          BUILD_ID=$(gcloud builds submit \
            --project "$GCP_PROJECT_ID" \
            --gcs-source-staging-dir "gs://${GCP_PROJECT_ID}_cloudbuild/source" \
            --pack "image=${IMAGE}" \
            --async \
            --format="value(id)" \
            .)
          echo "Build ID: $BUILD_ID"
          STATUS=""
          for i in $(seq 1 60); do
            STATUS=$(gcloud builds describe "$BUILD_ID" --project "$GCP_PROJECT_ID" --format="value(status)")
            echo "Build status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then
              break
            fi
            if [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              exit 1
            fi
            sleep 5
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "Build did not succeed."
            exit 1
          fi

      - name: Deploy image to Cloud Run (webhook)
        run: |
          WEBHOOK_SERVICE_NAME="${SERVICE_NAME}-webhook"
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${WEBHOOK_SERVICE_NAME}:${GITHUB_SHA}"
          gcloud run deploy "$WEBHOOK_SERVICE_NAME" \
            --project "$GCP_PROJECT_ID" \
            --region "$GCP_REGION" \
            --image "$IMAGE" \
            --allow-unauthenticated \
            --service-account "$RUNTIME_SA_EMAIL" \
            --set-env-vars "ENV_NAME=$ENV_NAME,FIRESTORE_PROJECT_ID=$FIRESTORE_PROJECT_ID,SERVICE_MODE=webhook" \
            --set-secrets "LINE_CHANNEL_SECRET=LINE_CHANNEL_SECRET:latest,LINE_CHANNEL_ACCESS_TOKEN=LINE_CHANNEL_ACCESS_TOKEN:latest,REDAC_MEMBERSHIP_ID_HMAC_SECRET=REDAC_MEMBERSHIP_ID_HMAC_SECRET:latest"
