name: Deploy to Cloud Run

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Deploy target environment"
        required: true
        default: stg
        type: choice
        options:
          - stg
          - prod
      confirm_production:
        description: "Required when target_environment=prod (type: DEPLOY_PROD)"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  RUNTIME_SA_EMAIL: ${{ vars.RUNTIME_SA_EMAIL }}
  DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
  ENV_NAME: ${{ vars.ENV_NAME }}
  PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}
  FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
  STORAGE_BUCKET: ${{ vars.STORAGE_BUCKET }}

jobs:
  dry-run:
    name: dry-run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Lint (if configured)
        run: |
          if [ -f package.json ] && grep -q "\"lint\"" package.json; then
            npm ci
            npm run lint
          else
            echo "lint skipped"
          fi

      - name: Preflight
        run: npm run preflight

      - name: Run tests
        run: npm test

      - name: Trace smoke (Phase136)
        run: npm run test:trace-smoke

      - name: Ops smoke (Phase155)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: npm run test:ops-smoke

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: dry-run
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' && 'prod' || 'stg' }}
    concurrency:
      group: deploy-member-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' && 'prod' || 'stg' }}
      cancel-in-progress: false
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCP_REGION: ${{ vars.GCP_REGION }}
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      RUNTIME_SA_EMAIL: ${{ vars.RUNTIME_SA_EMAIL }}
      DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}
      FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
      STORAGE_BUCKET: ${{ vars.STORAGE_BUCKET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate production confirmation
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'prod' }}
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY_PROD" ]; then
            echo "confirm_production must be DEPLOY_PROD when target_environment=prod"
            exit 1
          fi

      - name: Validate required deploy variables
        run: |
          REQUIRED_VARS=(
            GCP_PROJECT_ID
            GCP_REGION
            SERVICE_NAME
            GCP_WIF_PROVIDER
            RUNTIME_SA_EMAIL
            DEPLOY_SA_EMAIL
            ENV_NAME
            PUBLIC_BASE_URL
            FIRESTORE_PROJECT_ID
            STORAGE_BUCKET
          )
          MISSING=0
          for VAR_NAME in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!VAR_NAME}" ]; then
              echo "::error title=Missing workflow variable::${VAR_NAME} is empty"
              MISSING=1
            fi
          done
          if [ "$MISSING" -ne 0 ]; then
            exit 1
          fi

      - name: Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.DEPLOY_SA_EMAIL }}
          token_format: access_token

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Validate required secrets exist
        run: |
          REQUIRED_SECRETS=(
            LINE_CHANNEL_SECRET
            LINE_CHANNEL_ACCESS_TOKEN
            ADMIN_OS_TOKEN
            TRACK_TOKEN_SECRET
            REDAC_MEMBERSHIP_ID_HMAC_SECRET
            OPS_CONFIRM_TOKEN_SECRET
          )
          MISSING=0
          for SECRET_NAME in "${REQUIRED_SECRETS[@]}"; do
            if gcloud secrets describe "$SECRET_NAME" \
              --project "$GCP_PROJECT_ID" \
              --format='value(name)' >/dev/null 2>&1; then
              echo "Secret found: ${SECRET_NAME}"
            else
              echo "::error title=Missing Secret Manager secret::${SECRET_NAME} is missing or inaccessible in ${GCP_PROJECT_ID}"
              MISSING=1
            fi
          done
          if [ "$MISSING" -ne 0 ]; then
            exit 1
          fi

      - name: Ensure runtime SA can access required secrets
        run: |
          RUNTIME_MEMBER="serviceAccount:${RUNTIME_SA_EMAIL}"
          for SECRET_NAME in \
            LINE_CHANNEL_SECRET \
            LINE_CHANNEL_ACCESS_TOKEN \
            ADMIN_OS_TOKEN \
            TRACK_TOKEN_SECRET \
            REDAC_MEMBERSHIP_ID_HMAC_SECRET \
            OPS_CONFIRM_TOKEN_SECRET
          do
            echo "Granting roles/secretmanager.secretAccessor on ${SECRET_NAME} to ${RUNTIME_MEMBER}"
            if gcloud secrets add-iam-policy-binding "$SECRET_NAME" \
              --project "$GCP_PROJECT_ID" \
              --member "$RUNTIME_MEMBER" \
              --role "roles/secretmanager.secretAccessor" \
              --quiet >/dev/null; then
              echo "Secret IAM updated: ${SECRET_NAME}"
            else
              echo "::warning title=Secret IAM update skipped::${SECRET_NAME} secret IAM update failed (insufficient permission or secret not found); continuing deploy."
            fi
          done

      - name: Build image (Cloud Build)
        run: |
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${SERVICE_NAME}:${GITHUB_SHA}"
          BUILD_ID=$(gcloud builds submit \
            --project "$GCP_PROJECT_ID" \
            --gcs-source-staging-dir "gs://${GCP_PROJECT_ID}_cloudbuild/source" \
            --pack "image=${IMAGE}" \
            --async \
            --format="value(id)" \
            .)
          echo "Build ID: $BUILD_ID"
          STATUS=""
          for i in $(seq 1 60); do
            STATUS=$(gcloud builds describe "$BUILD_ID" --project "$GCP_PROJECT_ID" --format="value(status)")
            echo "Build status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then
              break
            fi
            if [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              exit 1
            fi
            sleep 5
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "Build did not succeed."
            exit 1
          fi

      - name: Deploy image to Cloud Run
        run: |
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${SERVICE_NAME}:${GITHUB_SHA}"
          gcloud run deploy "$SERVICE_NAME" \
            --project "$GCP_PROJECT_ID" \
            --region "$GCP_REGION" \
            --image "$IMAGE" \
            --no-allow-unauthenticated \
            --service-account "$RUNTIME_SA_EMAIL" \
            --set-env-vars "ENV_NAME=$ENV_NAME,PUBLIC_BASE_URL=$PUBLIC_BASE_URL,FIRESTORE_PROJECT_ID=$FIRESTORE_PROJECT_ID,STORAGE_BUCKET=$STORAGE_BUCKET" \
            --set-secrets "LINE_CHANNEL_SECRET=LINE_CHANNEL_SECRET:latest,LINE_CHANNEL_ACCESS_TOKEN=LINE_CHANNEL_ACCESS_TOKEN:latest,ADMIN_OS_TOKEN=ADMIN_OS_TOKEN:latest,TRACK_TOKEN_SECRET=TRACK_TOKEN_SECRET:latest,REDAC_MEMBERSHIP_ID_HMAC_SECRET=REDAC_MEMBERSHIP_ID_HMAC_SECRET:latest,OPS_CONFIRM_TOKEN_SECRET=OPS_CONFIRM_TOKEN_SECRET:latest"
