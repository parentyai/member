name: Deploy to Cloud Run

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  RUNTIME_SA_EMAIL: ${{ vars.RUNTIME_SA_EMAIL }}
  DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA }}
  ENV_NAME: ${{ vars.ENV_NAME }}
  PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}
  FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
  STORAGE_BUCKET: ${{ vars.STORAGE_BUCKET }}

jobs:
  dry-run:
    name: dry-run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Lint (if configured)
        run: |
          if [ -f package.json ] && grep -q "\"lint\"" package.json; then
            npm ci
            npm run lint
          else
            echo "lint skipped"
          fi

      - name: Preflight
        run: npm run preflight

      - name: Run tests
        run: npm test

      - name: Trace smoke (Phase136)
        run: npm run test:trace-smoke

      - name: Ops smoke (Phase155)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: npm run test:ops-smoke

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: dry-run
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.DEPLOY_SA_EMAIL }}
          token_format: access_token

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Build image (Cloud Build)
        run: |
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${SERVICE_NAME}:${GITHUB_SHA}"
          BUILD_ID=$(gcloud builds submit \
            --project "$GCP_PROJECT_ID" \
            --gcs-source-staging-dir "gs://${GCP_PROJECT_ID}_cloudbuild/source" \
            --pack "image=${IMAGE}" \
            --async \
            --format="value(id)" \
            .)
          echo "Build ID: $BUILD_ID"
          STATUS=""
          for i in $(seq 1 60); do
            STATUS=$(gcloud builds describe "$BUILD_ID" --project "$GCP_PROJECT_ID" --format="value(status)")
            echo "Build status: $STATUS"
            if [ "$STATUS" = "SUCCESS" ]; then
              break
            fi
            if [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              exit 1
            fi
            sleep 5
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "Build did not succeed."
            exit 1
          fi

      - name: Deploy image to Cloud Run
        run: |
          IMAGE="us-east1-docker.pkg.dev/${GCP_PROJECT_ID}/cloud-run-source-deploy/${SERVICE_NAME}:${GITHUB_SHA}"
          gcloud run deploy "$SERVICE_NAME" \
            --project "$GCP_PROJECT_ID" \
            --region "$GCP_REGION" \
            --image "$IMAGE" \
            --no-allow-unauthenticated \
            --service-account "$RUNTIME_SA_EMAIL" \
            --set-env-vars "ENV_NAME=$ENV_NAME,PUBLIC_BASE_URL=$PUBLIC_BASE_URL,FIRESTORE_PROJECT_ID=$FIRESTORE_PROJECT_ID,STORAGE_BUCKET=$STORAGE_BUCKET" \
            --set-secrets "LINE_CHANNEL_SECRET=LINE_CHANNEL_SECRET:latest,LINE_CHANNEL_ACCESS_TOKEN=LINE_CHANNEL_ACCESS_TOKEN:latest"
