name: phase22-scheduled-dryrun

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Auth (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_DEPLOY_SA }}
          token_format: access_token
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - name: Run Phase22 dry-run
        env:
          TRACK_BASE_URL: ${{ vars.TRACK_BASE_URL }}
          LINK_REGISTRY_ID: ${{ vars.LINK_REGISTRY_ID }}
          CTA_A: ${{ vars.CTA_A }}
          CTA_B: ${{ vars.CTA_B }}
          FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
          SERVICE_MODE: member
          PHASE21_VERIFY_REST: "1"
        run: |
          set +e
          FROM_UTC=$(date -u -d "yesterday" +%Y-%m-%dT00:00:00Z)
          TO_UTC=$(date -u +%Y-%m-%dT00:00:00Z)
          node scripts/phase22_scheduled_runner.js \
            --track-base-url "$TRACK_BASE_URL" \
            --linkRegistryId "$LINK_REGISTRY_ID" \
            --ctaA "$CTA_A" \
            --ctaB "$CTA_B" \
            --from "$FROM_UTC" \
            --to "$TO_UTC" \
            --runs 2 \
            --min-total-sent 2 \
            --min-delta-ctr 0 \
            > stdout.txt 2> stderr.txt
          code=$?
          echo "$code" > exit_code.txt
          set -e
          exit "$code"
      - name: KPI snapshot smoke (evidence)
        if: always()
        env:
          CTA_A: ${{ vars.CTA_A }}
          CTA_B: ${{ vars.CTA_B }}
          FIRESTORE_PROJECT_ID: ${{ vars.FIRESTORE_PROJECT_ID }}
        run: |
          FROM_UTC=$(date -u -d "yesterday" +%Y-%m-%dT00:00:00Z)
          TO_UTC=$(date -u +%Y-%m-%dT00:00:00Z)
          node scripts/phase22_kpi_snapshot_smoke.js \
            --ctaA "$CTA_A" \
            --ctaB "$CTA_B" \
            --from "$FROM_UTC" \
            --to "$TO_UTC" \
            > /tmp/phase22_kpi_smoke_stdout.json 2> /tmp/phase22_kpi_smoke_stderr.txt
      - name: Write Phase22 summary
        if: always()
        run: |
          set +e
          stdout_head="$(head -n 1 stdout.txt | head -c 2000)"
          result="stdout_parse_error"
          reason="stdout_parse_error"
          stage="stdout_parse_error"
          failure_class="UNKNOWN"
          nextAction="inspect artifacts"
          node_output=$(node -e 'const fs=require("fs"); const line=(fs.readFileSync("stdout.txt","utf8").split(/\\r?\\n/)[0]||""); const data=JSON.parse(line); console.log(String(data.result||"")); console.log(String(data.reasonCode||"")); console.log(String(data.stage||""));' 2>/dev/null)
          if [ $? -eq 0 ]; then
            result="$(printf "%s" "$node_output" | sed -n '1p')"
            reason="$(printf "%s" "$node_output" | sed -n '2p')"
            stage="$(printf "%s" "$node_output" | sed -n '3p')"
            if [ -z "$result" ]; then result="(empty)"; fi
            if [ -z "$reason" ]; then reason="(empty)"; fi
            if [ -z "$stage" ]; then stage="(empty)"; fi
          fi
          case "$reason" in
            INVALID_ARGS)
              failure_class="CONFIG"
              nextAction="fix workflow inputs"
              ;;
            SUBPROCESS_EXIT_NONZERO)
              failure_class="IMPL"
              nextAction="check gate reasons + thresholds"
              ;;
            RUNTIME_ERROR)
              failure_class="IMPL"
              nextAction="inspect stderr + stack"
              ;;
            VERIFY_ENV_ERROR|*VERIFY_ENV_ERROR*)
              failure_class="ENV"
              nextAction="fix credentials/ADC/GAC"
              ;;
            *)
              failure_class="UNKNOWN"
              nextAction="inspect artifacts"
              ;;
          esac
          humanDecisionHint="INSPECT_ARTIFACTS"
          if [ "$result" = "PASS" ]; then
            humanDecisionHint="NO_ACTION"
          else
            case "$failure_class" in
              ENV)
                humanDecisionHint="HOLD_AND_RERUN"
                ;;
              IMPL)
                humanDecisionHint="FIX_BEFORE_RERUN"
                ;;
              UNKNOWN)
                humanDecisionHint="INSPECT_ARTIFACTS"
                ;;
              *)
                humanDecisionHint="INSPECT_ARTIFACTS"
                ;;
            esac
          fi
          {
            echo "stdout_head: ${stdout_head}"
            echo "result: ${result}"
            echo "reasonCode: ${reason}"
            echo "stage: ${stage}"
            echo "failure_class: ${failure_class}"
            echo "nextAction: ${nextAction}"
            echo "humanDecisionHint: ${humanDecisionHint}"
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase22-dryrun
          path: |
            stdout.txt
            stderr.txt
            exit_code.txt
            /tmp/phase22_kpi_smoke_stdout.json
            /tmp/phase22_kpi_smoke_stderr.txt
