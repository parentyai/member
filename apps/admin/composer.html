<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>通知作成（Composer / 運用OS）</title>
    <link rel="stylesheet" href="/admin/assets/admin.css" />
  </head>
  <body>
    <div class="container">
      <div class="card-nav">
      <a class="card" href="/admin/ops">
        <div class="card-title">運用判断支援（Ops）</div>
        <div class="card-purpose">運用判断を安全に確定し、証跡を確認する。</div>
      </a>
      <a class="card card-active" href="/admin/composer">
        <div class="card-title">通知作成（Composer）</div>
        <div class="card-purpose">通知を作成・承認し、送信計画を安全に実行する。</div>
      </a>
      <a class="card" href="/admin/monitor">
        <div class="card-title">配信結果（Monitor）</div>
        <div class="card-purpose">配信反応と健康状態を把握し、異常を見逃さない。</div>
      </a>
      <a class="card" href="/admin/errors">
        <div class="card-title">エラー一覧（Errors）</div>
        <div class="card-purpose">WARN/Retryなどのエラーを素早く確認する。</div>
      </a>
      <a class="card" href="/admin/master">
        <div class="card-title">設定/回復（Master）</div>
        <div class="card-purpose">運用設定と回復操作を安全に実行する。</div>
      </a>
      <a class="card" href="/admin/read-model">
        <div class="card-title">通知集計（Read Model）</div>
        <div class="card-purpose">通知集計を参照し、判断材料を得る。</div>
      </a>
      <a class="card" href="/admin/review">
        <div class="card-title">運用レビュー記録（Review）</div>
        <div class="card-purpose">運用レビュー記録を残す。</div>
      </a>
      <a class="card" href="/admin/login">
        <div class="card-title">Admin Login</div>
        <div class="card-purpose">管理トークンで認証する。</div>
      </a>
      </div>

      <h1>通知作成（Composer / 運用OS）</h1>
      <div class="summary-header">
        <div class="summary-items"><span class="summary-label">見るべき3点</span><span>カテゴリ / 対象条件 / 確認トークン</span></div>
        <div class="summary-help"><span class="summary-label">迷ったら</span><span>Planで対象数を確認</span></div>
        <div class="summary-risk"><span class="summary-label">よくある失敗</span><span>limit未設定でplanが弾かれる</span></div>
      </div>
      <div class="layout section">
        <div class="layout-left panel-stack">
          <div id="composer-status-panel" class="panel panel-status status-card status-unknown">
            <div class="panel-title">状態サマリー</div>
            <div class="panel-body">
              <span class="status-pill status-unknown">未取得</span>
              <span class="status-legend">赤=要対応 / 黄=注意 / 緑=問題なし / 灰=未設定/不明</span>
              <div class="status-meta">直近操作の結果（作成/承認/計画/実行）</div>
              <div class="status-focus">今日の要対応: <span id="composer-action-count" class="action-count">0</span></div>
            </div>
          </div>
        </div>
        <div class="layout-right">
          <div class="action-panel panel-actions">
            <div class="panel-title">操作パネル</div>
            <div class="panel-body">
              <div class="note">手順は下書き → プレビュー → 承認 → 計画 → 実行の順です。</div>
              <div id="composer-skeleton" class="skeleton-stack is-hidden">
                <div class="skeleton-line lg w-50"></div>
                <div class="skeleton-line w-70"></div>
                <div class="skeleton-line w-30"></div>
              </div>

              <div class="note">
                <span data-tip="traceId" tabindex="0">追跡ID</span>:
                <input type="text" id="traceId" class="input-inline input-trace" />
                <button id="regen-trace" type="button">regen</button>
                <span id="trace-note"></span>
              </div>

              <div class="grid">
                <div>
                  <h2>下書き</h2>
                  <label data-tip="title" tabindex="0">タイトル</label>
                  <input id="title" />
                  <label data-tip="body" tabindex="0">本文</label>
                  <textarea id="body"></textarea>
                  <label data-tip="ctaText" tabindex="0">ボタン文言</label>
                  <input id="ctaText" />
                  <label data-tip="linkRegistryId" tabindex="0">リンクID</label>
                  <input id="linkRegistryId" placeholder="link registry のID" />

                  <div class="row">
                    <div class="flex-1">
                      <label data-tip="scenarioKey" tabindex="0">シナリオ</label>
                      <select id="scenarioKey">
                        <option value="A">A</option>
                        <option value="C">C</option>
                      </select>
                    </div>
                    <div class="flex-1">
                      <label data-tip="stepKey" tabindex="0">ステップ</label>
                      <select id="stepKey">
                        <option value="3mo">3mo</option>
                        <option value="1mo">1mo</option>
                        <option value="week">week</option>
                        <option value="after1w">after1w</option>
                      </select>
                    </div>
                  </div>
                  <label data-tip="notificationCategory" tabindex="0">カテゴリ</label>
                  <select id="notificationCategory">
                    <option value="DEADLINE_REQUIRED">DEADLINE_REQUIRED</option>
                    <option value="IMMEDIATE_ACTION">IMMEDIATE_ACTION</option>
                    <option value="SEQUENCE_GUIDANCE" selected>SEQUENCE_GUIDANCE</option>
                    <option value="TARGETED_ONLY">TARGETED_ONLY</option>
                    <option value="COMPLETION_CONFIRMATION">COMPLETION_CONFIRMATION</option>
                  </select>

                  <h3>対象条件</h3>
                  <div class="row">
                    <div class="flex-1">
                      <label data-tip="region" tabindex="0">地域（任意）</label>
                      <input id="targetRegion" />
                    </div>
                    <div class="flex-1">
                      <label data-tip="limit" tabindex="0">上限件数（必須）</label>
                      <input id="targetLimit" type="number" min="1" max="500" value="50" />
                    </div>
                  </div>
                  <label data-tip="membersOnly" tabindex="0"><input id="membersOnly" type="checkbox" /> 会員のみ</label>

                  <div class="row row-top">
                    <button id="create-draft" type="button">下書き作成</button>
                    <button id="preview" type="button">プレビュー</button>
                    <button id="approve" type="button">承認（有効化）</button>
                  </div>
                  <div class="note"><span data-tip="notificationId" tabindex="0">通知ID</span>: <span id="notificationId">-</span></div>
                  <pre id="draft-result">-</pre>
                </div>

                <details class="panel danger-zone" open>
                  <summary>計画 / 実行（危険操作）</summary>
                  <div class="panel-body">
                    <h2>計画 / 実行（危険操作）</h2>
                    <div class="note danger">送信を伴う操作です。kill switch の状態を確認してください。</div>
                    <div class="row">
                      <button id="plan" type="button">送信計画</button>
                      <button id="execute" type="button">送信実行</button>
                    </div>
                    <div class="note">
                      <span data-tip="planHash" tabindex="0">計画ハッシュ</span>: <span id="planHash">-</span>
                      / <span data-tip="confirmToken" tabindex="0">確認トークン</span>: <span id="confirmToken">-</span>
                    </div>
                    <div class="note">
                      対象人数（plan）: <span id="planTargetCount">-</span>
                    </div>
                    <div class="note">
                      抑制数（plan）: <span id="planCapBlockedCount">-</span>
                    </div>
                    <pre id="plan-result">-</pre>
                    <pre id="execute-result">-</pre>
                    <div class="note" id="execute-cap-meta" data-tip="capCountMode / capCountSource / capCountStrategy / lastExecuteReason" tabindex="0">計数方式: - / 計数元: - / 計数戦略: - / 最終理由: -</div>
                  </div>
                </details>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>

    <script>
      const OPS_ACTOR_HEADERS = { 'x-actor': 'admin_composer' };

      function newTraceId() {
        if (globalThis.crypto && typeof globalThis.crypto.randomUUID === 'function') {
          return globalThis.crypto.randomUUID();
        }
        return `trace-${Date.now()}-${Math.floor(Math.random() * 1e9)}`;
      }

      function getTraceId() {
        const el = document.getElementById('traceId');
        const value = el.value.trim();
        return value.length ? value : null;
      }

      function setTraceId(value) {
        const el = document.getElementById('traceId');
        el.value = value || '';
      }

      function jsonOrText(res) {
        return res.text().then((text) => {
          try { return JSON.parse(text); } catch (_err) { return { ok: false, error: text || 'error' }; }
        });
      }

      function buildTarget() {
        const region = document.getElementById('targetRegion').value.trim();
        const limitValue = document.getElementById('targetLimit').value;
        const limit = limitValue ? Number(limitValue) : null;
        const membersOnly = document.getElementById('membersOnly').checked;
        const target = {};
        if (region) target.region = region;
        if (membersOnly) target.membersOnly = true;
        if (limit) target.limit = limit;
        return target;
      }

      function buildDraftPayload() {
        return {
          title: document.getElementById('title').value.trim(),
          body: document.getElementById('body').value,
          ctaText: document.getElementById('ctaText').value.trim(),
          linkRegistryId: document.getElementById('linkRegistryId').value.trim(),
          scenarioKey: document.getElementById('scenarioKey').value,
          stepKey: document.getElementById('stepKey').value,
          notificationCategory: document.getElementById('notificationCategory').value,
          target: buildTarget()
        };
      }

      let currentNotificationId = null;
      let currentPlanHash = null;
      let currentConfirmToken = null;

      const toastEl = document.getElementById('toast');
      const skeletonEl = document.getElementById('composer-skeleton');
      const statusPanelEl = document.getElementById('composer-status-panel');

      function showToast(message, tone) {
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.className = `toast ${tone || ''} show`;
        setTimeout(() => {
          toastEl.className = 'toast';
          toastEl.textContent = '';
        }, 2200);
      }

      function setLoading(isLoading) {
        if (!skeletonEl) return;
        skeletonEl.classList.toggle('is-hidden', !isLoading);
      }

      function setStatusTone(tone) {
        if (!statusPanelEl) return;
        statusPanelEl.classList.remove('status-ok', 'status-warn', 'status-danger', 'status-unknown');
        statusPanelEl.classList.add(`status-${tone || 'unknown'}`);
      }

      async function postJson(url, payload) {
        const traceId = getTraceId() || newTraceId();
        setTraceId(traceId);
        setLoading(true);
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: Object.assign({ 'content-type': 'application/json; charset=utf-8', 'x-trace-id': traceId }, OPS_ACTOR_HEADERS),
            body: JSON.stringify(payload || {})
          });
          return jsonOrText(res);
        } finally {
          setLoading(false);
        }
      }

      document.getElementById('regen-trace').addEventListener('click', () => {
        setTraceId(newTraceId());
        document.getElementById('trace-note').textContent = '';
      });

      setTraceId(newTraceId());

      // Best-effort view audit (do not block UI).
      (async () => {
        try {
          const traceId = getTraceId() || newTraceId();
          await fetch('/api/admin/os/view', {
            method: 'POST',
            headers: Object.assign({ 'content-type': 'application/json; charset=utf-8', 'x-trace-id': traceId }, OPS_ACTOR_HEADERS),
            body: JSON.stringify({ screen: 'composer' })
          });
        } catch (_err) {}
      })();

      document.getElementById('create-draft').addEventListener('click', async () => {
        const resultEl = document.getElementById('draft-result');
        resultEl.textContent = '';
        const payload = buildDraftPayload();
        const result = await postJson('/api/admin/os/notifications/draft', payload);
        resultEl.textContent = JSON.stringify(result, null, 2);
        if (result && result.ok && result.notificationId) {
          currentNotificationId = result.notificationId;
          document.getElementById('notificationId').textContent = currentNotificationId;
          currentPlanHash = null;
          currentConfirmToken = null;
          document.getElementById('planHash').textContent = '-';
          document.getElementById('confirmToken').textContent = '-';
          showToast('draft 作成 OK', 'ok');
          setStatusTone('ok');
        } else {
          showToast('draft 作成 失敗', 'danger');
          setStatusTone('danger');
        }
      });

      document.getElementById('preview').addEventListener('click', async () => {
        const resultEl = document.getElementById('draft-result');
        const payload = Object.assign({}, buildDraftPayload(), { notificationId: currentNotificationId });
        const result = await postJson('/api/admin/os/notifications/preview', payload);
        resultEl.textContent = JSON.stringify(result, null, 2);
        if (result && result.ok) {
          showToast('preview OK', 'ok');
          setStatusTone('ok');
        } else {
          showToast('preview 失敗', 'danger');
          setStatusTone('danger');
        }
      });

      document.getElementById('approve').addEventListener('click', async () => {
        const resultEl = document.getElementById('draft-result');
        if (!currentNotificationId) {
        resultEl.textContent = '通知IDが必要です（先に下書きを作成）';
        showToast('通知IDが必要です', 'warn');
          setStatusTone('warn');
          return;
        }
        const result = await postJson('/api/admin/os/notifications/approve', { notificationId: currentNotificationId });
        resultEl.textContent = JSON.stringify(result, null, 2);
        if (result && result.ok) {
          showToast('approve OK', 'ok');
          setStatusTone('ok');
        } else {
          showToast('approve 失敗', 'danger');
          setStatusTone('danger');
        }
      });

      document.getElementById('plan').addEventListener('click', async () => {
        const resultEl = document.getElementById('plan-result');
        const planTargetCountEl = document.getElementById('planTargetCount');
        const planCapBlockedEl = document.getElementById('planCapBlockedCount');
        resultEl.textContent = '';
        if (planTargetCountEl) planTargetCountEl.textContent = '-';
        if (planCapBlockedEl) planCapBlockedEl.textContent = '-';
        if (!currentNotificationId) {
          resultEl.textContent = '通知IDが必要です';
          showToast('通知IDが必要です', 'warn');
          setStatusTone('warn');
          return;
        }
        const result = await postJson('/api/admin/os/notifications/send/plan', {
          notificationId: currentNotificationId
        });
        resultEl.textContent = JSON.stringify(result, null, 2);
        if (result && result.ok) {
          currentPlanHash = result.planHash || null;
          currentConfirmToken = result.confirmToken || null;
          document.getElementById('planHash').textContent = currentPlanHash || '-';
          document.getElementById('confirmToken').textContent = currentConfirmToken ? 'set' : '-';
          if (planTargetCountEl) {
            const count = typeof result.count === 'number' ? result.count : null;
            planTargetCountEl.textContent = count !== null ? String(count) : '-';
          }
          if (planCapBlockedEl) {
            const blocked = typeof result.capBlockedCount === 'number' ? result.capBlockedCount : null;
            planCapBlockedEl.textContent = blocked !== null ? String(blocked) : '-';
          }
          showToast('plan OK', 'ok');
          setStatusTone('ok');
        } else {
          showToast('plan 失敗', 'danger');
          setStatusTone('danger');
        }
      });

      document.getElementById('execute').addEventListener('click', async () => {
        const resultEl = document.getElementById('execute-result');
        const metaEl = document.getElementById('execute-cap-meta');
        resultEl.textContent = '';
        if (!currentNotificationId || !currentPlanHash || !currentConfirmToken) {
          resultEl.textContent = '計画ハッシュと確認トークンが必要です（先に計画）';
          showToast('計画ハッシュ/確認トークンが必要です', 'warn');
          setStatusTone('warn');
          return;
        }
        const result = await postJson('/api/admin/os/notifications/send/execute', {
          notificationId: currentNotificationId,
          planHash: currentPlanHash,
          confirmToken: currentConfirmToken
        });
        resultEl.textContent = JSON.stringify(result, null, 2);
        if (metaEl) {
          const reason = result && typeof result === 'object' && result.reason
            ? result.reason
            : (result && result.ok ? 'ok' : '-');
          const capCountMode = result && typeof result === 'object' ? (result.capCountMode || '-') : '-';
          const capCountSource = result && typeof result === 'object' ? (result.capCountSource || '-') : '-';
          const capCountStrategy = result && typeof result === 'object' ? (result.capCountStrategy || '-') : '-';
          metaEl.textContent = `計数方式: ${capCountMode} / 計数元: ${capCountSource} / 計数戦略: ${capCountStrategy} / 最終理由: ${reason}`;
        }
        if (result && result.ok) {
          showToast('execute OK', 'ok');
          setStatusTone('ok');
        } else {
          showToast('execute 失敗', 'danger');
          setStatusTone('danger');
        }
      });
    </script>
  </body>
</html>
