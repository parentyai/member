<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Master Data（運用OS）</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #222; }
      .nav a { margin-right: 12px; }
      .note { font-size: 12px; color: #666; margin: 8px 0; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
      label { display: block; font-size: 12px; color: #333; margin-top: 8px; }
      input, textarea, select { width: 100%; padding: 6px 8px; font-size: 14px; }
      textarea { min-height: 80px; }
      button { padding: 6px 10px; font-size: 14px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 6px; text-align: left; font-size: 13px; }
      th { background: #f7f7f7; }
      pre { background: #f7f7f7; padding: 8px; border: 1px solid #eee; overflow: auto; }
    </style>
  </head>
  <body>
    <div class="nav">
      <a href="/admin/ops">ops</a>
      <a href="/admin/composer">composer</a>
      <a href="/admin/monitor">monitor</a>
      <a href="/admin/errors">errors</a>
    </div>

    <h1>Master Data（運用OS）</h1>
    <div class="note">templates / link_registry を UI から管理（add-only）。</div>

    <div class="note">
      traceId:
      <input type="text" id="traceId" style="max-width: 420px;" />
      <button id="regen-trace" type="button">regen</button>
      <span id="trace-note"></span>
    </div>

    <div class="grid">
      <div>
        <h2>Templates</h2>
        <div class="note">API: `/api/phase61/templates`</div>
        <div class="note">
          status:
          <select id="tpl-status">
            <option value="">(all)</option>
            <option value="draft">draft</option>
            <option value="active">active</option>
            <option value="inactive">inactive</option>
          </select>
          <button id="tpl-reload" type="button">reload</button>
        </div>
        <table>
          <thead>
            <tr><th>key</th><th>status</th><th>title</th><th>actions</th></tr>
          </thead>
          <tbody id="tpl-rows"></tbody>
        </table>

        <h3>Create Template</h3>
        <label>key</label>
        <input id="tpl-key" placeholder="ops_escalate" />
        <label>title</label>
        <input id="tpl-title" />
        <label>text/body</label>
        <textarea id="tpl-text"></textarea>
        <button id="tpl-create" type="button">create</button>
        <pre id="tpl-result">-</pre>
      </div>

      <div>
        <h2>Link Registry</h2>
        <div class="note">API: `/admin/link-registry`</div>
        <div class="note">
          state:
          <select id="link-state">
            <option value="">(all)</option>
            <option value="OK">OK</option>
            <option value="WARN">WARN</option>
          </select>
          <button id="link-reload" type="button">reload</button>
        </div>
        <table>
          <thead>
            <tr><th>id</th><th>title</th><th>url</th><th>state</th></tr>
          </thead>
          <tbody id="link-rows"></tbody>
        </table>

        <h3>Create Link</h3>
        <label>title</label>
        <input id="link-title" />
        <label>url</label>
        <input id="link-url" placeholder="https://..." />
        <button id="link-create" type="button">create</button>
        <pre id="link-result">-</pre>
      </div>
    </div>

    <hr />

    <h2>Ridacクラブ会員ID（例外解除）</h2>
    <div class="note">
      重複拒否（B）の運用で詰まった場合のみ使用。入力した会員ID全文は保存しない（HMAC hash + last4のみ）。
      誰に紐付いているかは「解除結果」でのみ返る（運用者向け）。
    </div>
    <label>ridacMembershipId（例: 00-0000）</label>
    <input id="ridac-unlink-id" placeholder="00-0000" />
    <button id="ridac-unlink" type="button">unlink</button>
    <pre id="ridac-unlink-result">-</pre>

    <hr />

    <h2>System Config（SSOT）</h2>
    <div class="note">servicePhase / notificationPreset を安全に変更（plan → confirmToken → set）。</div>
    <div class="note">
      <button id="config-reload" type="button">reload status</button>
    </div>
    <pre id="config-status">-</pre>

    <div class="grid">
      <div>
        <label>servicePhase（null = clear）</label>
        <select id="config-service-phase">
          <option value="">(null)</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div>
        <label>notificationPreset（null = clear）</label>
        <select id="config-notification-preset">
          <option value="">(null)</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
    </div>
    <div class="note">
      <button id="config-plan" type="button">plan</button>
      <button id="config-set" type="button">set</button>
    </div>
    <pre id="config-plan-result">-</pre>
    <pre id="config-set-result">-</pre>

    <script>
      const ACTOR_HEADERS = { 'x-actor': 'admin_master' };
      const TRACE_HEADER_NAME = 'x-trace-id';
      let configPlanHash = null;
      let configConfirmToken = null;

      function newTraceId() {
        if (globalThis.crypto && typeof globalThis.crypto.randomUUID === 'function') {
          return globalThis.crypto.randomUUID();
        }
        return `trace-${Date.now()}-${Math.floor(Math.random() * 1e9)}`;
      }

      function getTraceId() {
        const el = document.getElementById('traceId');
        const value = el.value.trim();
        return value.length ? value : null;
      }

      function setTraceId(value) {
        const el = document.getElementById('traceId');
        el.value = value || '';
      }

      function ensureTraceId() {
        const value = getTraceId();
        if (value) return value;
        const next = newTraceId();
        setTraceId(next);
        return next;
      }

      function buildHeaders(extra) {
        const traceId = ensureTraceId();
        return Object.assign({}, extra || {}, ACTOR_HEADERS, { [TRACE_HEADER_NAME]: traceId });
      }

      document.getElementById('regen-trace').addEventListener('click', () => {
        setTraceId(newTraceId());
        document.getElementById('trace-note').textContent = '';
      });

      setTraceId(newTraceId());

      // Best-effort view audit (do not block UI).
      (async () => {
        try {
          const traceId = ensureTraceId();
          await fetch('/api/admin/os/view', {
            method: 'POST',
            headers: Object.assign({ 'content-type': 'application/json; charset=utf-8', [TRACE_HEADER_NAME]: traceId }, ACTOR_HEADERS),
            body: JSON.stringify({ screen: 'master' })
          });
        } catch (_err) {}
      })();

      function clearChildren(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function appendMessageRow(tbody, colSpan, message) {
        clearChildren(tbody);
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = colSpan;
        td.textContent = message;
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      function appendRow(tbody, values) {
        const tr = document.createElement('tr');
        for (const value of values) {
          const td = document.createElement('td');
          if (value instanceof Node) {
            td.appendChild(value);
          } else {
            td.textContent = value === null || value === undefined ? '-' : String(value);
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function jsonOrText(res) {
        return res.text().then((text) => {
          try { return JSON.parse(text); } catch (_err) { return { ok: false, error: text || 'error' }; }
        });
      }

      async function loadTemplates() {
        const status = document.getElementById('tpl-status').value;
        const params = new URLSearchParams();
        if (status) params.set('status', status);
        const res = await fetch(`/api/phase61/templates${params.toString() ? `?${params.toString()}` : ''}`, { headers: buildHeaders() });
        const data = await res.json();
        const rows = document.getElementById('tpl-rows');
        if (!data.ok) {
          appendMessageRow(rows, 4, 'error');
          return;
        }
        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          appendMessageRow(rows, 4, 'no data');
          return;
        }
        clearChildren(rows);
        for (const item of items) {
          const actions = document.createElement('span');

          const activateBtn = document.createElement('button');
          activateBtn.type = 'button';
          activateBtn.textContent = 'activate';
          activateBtn.addEventListener('click', async () => {
            const key = item && item.key ? String(item.key) : '';
            if (!key) return;
            const res2 = await fetch(`/api/phase61/templates/${encodeURIComponent(key)}/activate`, {
              method: 'POST',
              headers: buildHeaders()
            });
            document.getElementById('tpl-result').textContent = JSON.stringify(await res2.json(), null, 2);
            await loadTemplates();
          });
          actions.appendChild(activateBtn);

          const space = document.createTextNode(' ');
          actions.appendChild(space);

          const deactivateBtn = document.createElement('button');
          deactivateBtn.type = 'button';
          deactivateBtn.textContent = 'deactivate';
          deactivateBtn.addEventListener('click', async () => {
            const key = item && item.key ? String(item.key) : '';
            if (!key) return;
            const res2 = await fetch(`/api/phase61/templates/${encodeURIComponent(key)}/deactivate`, {
              method: 'POST',
              headers: buildHeaders()
            });
            document.getElementById('tpl-result').textContent = JSON.stringify(await res2.json(), null, 2);
            await loadTemplates();
          });
          actions.appendChild(deactivateBtn);

          appendRow(rows, [
            item.key || '-',
            item.status || '-',
            item.title || '-',
            actions
          ]);
        }
      }

      async function createTemplate() {
        const payload = {
          key: document.getElementById('tpl-key').value.trim(),
          title: document.getElementById('tpl-title').value.trim(),
          text: document.getElementById('tpl-text').value
        };
        const res = await fetch('/api/phase61/templates', {
          method: 'POST',
          headers: buildHeaders({ 'content-type': 'application/json; charset=utf-8' }),
          body: JSON.stringify(payload)
        });
        document.getElementById('tpl-result').textContent = JSON.stringify(await res.json(), null, 2);
        await loadTemplates();
      }

      async function loadLinks() {
        const state = document.getElementById('link-state').value;
        const params = new URLSearchParams();
        if (state) params.set('state', state);
        const res = await fetch(`/admin/link-registry${params.toString() ? `?${params.toString()}` : ''}`, { headers: buildHeaders() });
        const data = await res.json();
        const rows = document.getElementById('link-rows');
        if (!data.ok) {
          appendMessageRow(rows, 4, 'error');
          return;
        }
        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          appendMessageRow(rows, 4, 'no data');
          return;
        }
        clearChildren(rows);
        for (const item of items) {
          appendRow(rows, [
            item.id || '-',
            item.title || '-',
            item.url || '-',
            item.lastHealth && item.lastHealth.state ? item.lastHealth.state : '-'
          ]);
        }
      }

      async function createLink() {
        const payload = {
          title: document.getElementById('link-title').value.trim(),
          url: document.getElementById('link-url').value.trim()
        };
        const res = await fetch('/admin/link-registry', {
          method: 'POST',
          headers: buildHeaders({ 'content-type': 'application/json; charset=utf-8' }),
          body: JSON.stringify(payload)
        });
        document.getElementById('link-result').textContent = JSON.stringify(await jsonOrText(res), null, 2);
        await loadLinks();
      }

      async function unlinkRidacMembership() {
        const ridacMembershipId = document.getElementById('ridac-unlink-id').value.trim();
        if (!ridacMembershipId) return;
        const ok = window.confirm(`Ridac会員IDを解除しますか？\n\n${ridacMembershipId}\n\n(例外対応: 通常は使いません)`); // eslint-disable-line no-alert
        if (!ok) return;
        const res = await fetch('/api/admin/ridac-membership/unlink', {
          method: 'POST',
          headers: buildHeaders({ 'content-type': 'application/json; charset=utf-8' }),
          body: JSON.stringify({ ridacMembershipId })
        });
        document.getElementById('ridac-unlink-result').textContent = JSON.stringify(await jsonOrText(res), null, 2);
      }

      function parseNullableInt(value) {
        const trimmed = String(value || '').trim();
        if (!trimmed) return null;
        const num = Number(trimmed);
        if (!Number.isInteger(num)) return null;
        return num;
      }

      function parseNullableString(value) {
        const trimmed = String(value || '').trim();
        return trimmed ? trimmed : null;
      }

      async function loadSystemConfigStatus() {
        const res = await fetch('/api/admin/os/config/status', { headers: buildHeaders() });
        const data = await jsonOrText(res);
        document.getElementById('config-status').textContent = JSON.stringify(data, null, 2);
        if (data && data.ok) {
          const sp = data.servicePhase === null || data.servicePhase === undefined ? '' : String(data.servicePhase);
          document.getElementById('config-service-phase').value = sp;
          const preset = data.notificationPreset ? String(data.notificationPreset) : '';
          document.getElementById('config-notification-preset').value = preset;
        }
      }

      async function planSystemConfig() {
        const servicePhase = parseNullableInt(document.getElementById('config-service-phase').value);
        const notificationPreset = parseNullableString(document.getElementById('config-notification-preset').value);
        const res = await fetch('/api/admin/os/config/plan', {
          method: 'POST',
          headers: buildHeaders({ 'content-type': 'application/json; charset=utf-8' }),
          body: JSON.stringify({ servicePhase, notificationPreset })
        });
        const data = await jsonOrText(res);
        document.getElementById('config-plan-result').textContent = JSON.stringify(data, null, 2);
        configPlanHash = data && data.ok ? data.planHash || null : null;
        configConfirmToken = data && data.ok ? data.confirmToken || null : null;
      }

      async function setSystemConfig() {
        const servicePhase = parseNullableInt(document.getElementById('config-service-phase').value);
        const notificationPreset = parseNullableString(document.getElementById('config-notification-preset').value);
        if (!configPlanHash || !configConfirmToken) {
          document.getElementById('config-set-result').textContent = JSON.stringify({ ok: false, error: 'plan required' }, null, 2);
          return;
        }
        const ok = window.confirm(`System Config を set しますか？\n\nservicePhase=${servicePhase === null ? 'null' : String(servicePhase)}\nnotificationPreset=${notificationPreset === null ? 'null' : String(notificationPreset)}`); // eslint-disable-line no-alert
        if (!ok) return;
        const res = await fetch('/api/admin/os/config/set', {
          method: 'POST',
          headers: buildHeaders({ 'content-type': 'application/json; charset=utf-8' }),
          body: JSON.stringify({ servicePhase, notificationPreset, planHash: configPlanHash, confirmToken: configConfirmToken })
        });
        const data = await jsonOrText(res);
        document.getElementById('config-set-result').textContent = JSON.stringify(data, null, 2);
        await loadSystemConfigStatus();
      }

      document.getElementById('tpl-reload').addEventListener('click', () => loadTemplates().catch(() => {}));
      document.getElementById('tpl-create').addEventListener('click', () => createTemplate().catch(() => {}));
      document.getElementById('link-reload').addEventListener('click', () => loadLinks().catch(() => {}));
      document.getElementById('link-create').addEventListener('click', () => createLink().catch(() => {}));
      document.getElementById('ridac-unlink').addEventListener('click', () => unlinkRidacMembership().catch(() => {}));
      document.getElementById('config-reload').addEventListener('click', () => loadSystemConfigStatus().catch(() => {}));
      document.getElementById('config-plan').addEventListener('click', () => planSystemConfig().catch(() => {}));
      document.getElementById('config-set').addEventListener('click', () => setSystemConfig().catch(() => {}));

      loadTemplates().catch(() => {});
      loadLinks().catch(() => {});
      loadSystemConfigStatus().catch(() => {});
    </script>
  </body>
</html>
