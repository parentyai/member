<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>運用判断支援（READ ONLY）</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #222; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
      th { background: #f7f7f7; }
      .note { font-size: 12px; color: #666; margin-bottom: 8px; }
      .section { margin-bottom: 24px; }
      .btn { font-size: 12px; padding: 4px 8px; }
    </style>
  </head>
  <body>
    <h1>運用判断支援（READ ONLY）</h1>
    <div class="note">表示のみ。判断と操作は人間が行います。</div>

    <div class="section">
      <h2>ユーザー状態一覧（READ ONLY）</h2>
      <div class="note">期間フィルタ（UTC）</div>
      <div class="note">
        from: <input type="date" id="users-from" />
        to: <input type="date" id="users-to" />
        <button class="btn" id="users-apply">適用</button>
      </div>
      <div class="note" id="user-summary-note"></div>
      <table>
        <thead>
          <tr>
            <th>lineUserId</th>
            <th>memberNumber</th>
            <th>checklist</th>
            <th>lastActionAt</th>
            <th>詳細</th>
          </tr>
        </thead>
        <tbody id="users-rows"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>通知状態一覧</h2>
      <div class="note">期間フィルタ（UTC）</div>
      <div class="note">
        from: <input type="date" id="notifications-from" />
        to: <input type="date" id="notifications-to" />
        <button class="btn" id="notifications-apply">適用</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>notificationId</th>
            <th>sentAt</th>
            <th>open</th>
            <th>click</th>
            <th>lastReactionAt</th>
            <th>詳細</th>
          </tr>
        </thead>
        <tbody id="notifications-rows"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>memberNumber 未入力（14日超）</h2>
      <div class="note" id="member-stale-count"></div>
      <table>
        <thead>
          <tr>
            <th>lineUserId</th>
            <th>createdAt</th>
            <th>daysSinceCreated</th>
          </tr>
        </thead>
        <tbody id="member-stale-rows"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Last reviewed</h2>
      <div class="note">手動入力のみ（閲覧や集計では更新しない）</div>
      <div>At: <span id="ops-review-at">-</span></div>
      <div>By: <span id="ops-review-by">-</span></div>
    </div>

    <script>
      function buildRangeQuery(prefix) {
        const from = document.getElementById(`${prefix}-from`).value;
        const to = document.getElementById(`${prefix}-to`).value;
        const params = new URLSearchParams();
        if (from) params.set('from', from);
        if (to) params.set('to', to);
        const qs = params.toString();
        return qs ? `?${qs}` : '';
      }

      async function loadUsers() {
        const res = await fetch(`/api/phase5/ops/users-summary${buildRangeQuery('users')}`);
        const data = await res.json();
        const rows = document.getElementById('users-rows');
        const note = document.getElementById('user-summary-note');
        renderReview(data.review);
        if (!data.ok) {
          rows.innerHTML = '<tr><td colspan="5">error</td></tr>';
          return;
        }
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="5">no data</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.lineUserId}</td>
            <td>${item.hasMemberNumber ? 'あり' : 'なし'}</td>
            <td>${item.checklistCompleted}/${item.checklistTotal}</td>
            <td>${item.lastActionAt || '-'}</td>
            <td><button class="btn" disabled>詳細を見る</button></td>
          </tr>
        `).join('');

        const params = new URLSearchParams(location.search);
        const lineUserId = params.get('lineUserId');
        if (!lineUserId) {
          note.textContent = 'lineUserId を指定すると個別の状態サマリを表示します';
          return;
        }
        const summaryRes = await fetch(`/api/phase5/state/summary?lineUserId=${encodeURIComponent(lineUserId)}`);
        const summary = await summaryRes.json();
        if (summary.ok && summary.item) {
          const item = summary.item;
          note.textContent = `summary: ${item.lineUserId} / memberNumber: ${item.hasMemberNumber ? 'あり' : 'なし'} / checklist: ${item.checklistCompleted}/${item.checklistTotal} / lastActionAt: ${item.lastActionAt || '-'}`;
        } else {
          note.textContent = 'summary: unavailable';
        }
      }

      async function loadNotifications() {
        const res = await fetch(`/api/phase5/ops/notifications-summary${buildRangeQuery('notifications')}`);
        const data = await res.json();
        const rows = document.getElementById('notifications-rows');
        if (!data.ok) {
          rows.innerHTML = '<tr><td colspan="6">error</td></tr>';
          return;
        }
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="6">no data</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.notificationId}</td>
            <td>${item.sentAt || '-'}</td>
            <td>${item.openCount}</td>
            <td>${item.clickCount}</td>
            <td>${item.lastReactionAt || '-'}</td>
            <td><button class="btn" disabled>詳細を見る</button></td>
          </tr>
        `).join('');
      }

      async function loadStaleMemberNumber() {
        const res = await fetch('/api/phase5/ops/member-number-stale');
        const data = await res.json();
        const countEl = document.getElementById('member-stale-count');
        const rows = document.getElementById('member-stale-rows');
        if (!data.ok) {
          countEl.textContent = 'error';
          rows.innerHTML = '<tr><td colspan="3">error</td></tr>';
          return;
        }
        countEl.textContent = `count: ${data.count}`;
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="3">none</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.lineUserId}</td>
            <td>${item.createdAt || '-'}</td>
            <td>${item.daysSinceCreated}</td>
          </tr>
        `).join('');
      }

      function renderReview(review) {
        const atEl = document.getElementById('ops-review-at');
        const byEl = document.getElementById('ops-review-by');
        if (!atEl || !byEl) return;
        if (!review || !review.lastReviewedAt || !review.lastReviewedBy) {
          atEl.textContent = '-';
          byEl.textContent = '-';
          return;
        }
        atEl.textContent = review.lastReviewedAt;
        byEl.textContent = review.lastReviewedBy;
      }

      document.getElementById('users-apply').addEventListener('click', () => {
        loadUsers().catch(() => {});
      });
      document.getElementById('notifications-apply').addEventListener('click', () => {
        loadNotifications().catch(() => {});
      });

      Promise.all([loadUsers(), loadNotifications(), loadStaleMemberNumber()]).catch(() => {
        document.getElementById('users-rows').innerHTML = '<tr><td colspan="5">error</td></tr>';
        document.getElementById('notifications-rows').innerHTML = '<tr><td colspan="6">error</td></tr>';
        document.getElementById('member-stale-rows').innerHTML = '<tr><td colspan="3">error</td></tr>';
      });
    </script>
  </body>
</html>
