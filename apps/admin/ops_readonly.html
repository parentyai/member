<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>運用判断支援（READ ONLY）</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 16px; color: #222; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
      th { background: #f7f7f7; }
      .note { font-size: 12px; color: #666; margin-bottom: 8px; }
      .section { margin-bottom: 24px; }
      .btn { font-size: 12px; padding: 4px 8px; }
    </style>
  </head>
  <body>
    <h1>運用判断支援（READ ONLY）</h1>
    <div class="note">表示のみ。判断と操作は人間が行います。</div>
    <div class="note">
      <a href="/admin/read-model">通知集計</a> |
      <a href="#implementation-targets">Implementation Targets</a>
    </div>

    <div class="section">
      <h2>ユーザー状態一覧（READ ONLY）</h2>
      <div class="note">期間フィルタ（UTC）</div>
      <div class="note">
        from: <input type="date" id="users-from" />
        to: <input type="date" id="users-to" />
        <button class="btn" id="users-apply">適用</button>
      </div>
      <div class="note">
        <label><input type="checkbox" id="filter-needsAttention" /> needsAttention</label>
        <label><input type="checkbox" id="filter-stale" /> stale</label>
        <label><input type="checkbox" id="filter-unreviewed" /> unreviewed</label>
        <label>reviewAgeDays: <input type="number" id="filter-reviewAgeDays" min="1" max="365" /></label>
      </div>
      <div class="note" id="user-summary-note"></div>
      <table>
        <thead>
          <tr>
            <th>lineUserId</th>
            <th>memberNumber</th>
            <th>checklist</th>
            <th>stale</th>
            <th>needsAttention</th>
            <th>lastReviewedAt</th>
            <th>lastReviewedBy</th>
            <th>lastActionAt</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="users-rows"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>通知状態一覧</h2>
      <div class="note">期間フィルタ（UTC）</div>
      <div class="note">
        from: <input type="date" id="notifications-from" />
        to: <input type="date" id="notifications-to" />
        <button class="btn" id="notifications-apply">適用</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>notificationId</th>
            <th>sentAt</th>
            <th>open</th>
            <th>click</th>
            <th>lastReactionAt</th>
            <th>詳細</th>
          </tr>
        </thead>
        <tbody id="notifications-rows"></tbody>
      </table>
    </div>

    <div class="section" id="ops-console-list-section">
      <h2>Ops Console（Phase26 list）</h2>
      <div class="note">運用判断の一覧（READY優先・安定ソート）。</div>
      <div class="note">
        limit: <input type="number" id="ops-console-limit" min="1" max="200" value="20" />
        <button class="btn" id="ops-console-refresh">更新</button>
      </div>
      <div class="note" id="ops-console-list-note"></div>
      <div class="note" id="ops-console-list-error"></div>
      <table>
        <thead>
          <tr>
            <th>lineUserId</th>
            <th>readiness</th>
            <th>recommendedNextAction</th>
            <th>allowedNextActions</th>
            <th>opsState.nextAction</th>
            <th>latestDecisionLog</th>
            <th>詳細</th>
          </tr>
        </thead>
        <tbody id="ops-console-list-rows"></tbody>
      </table>
    </div>

    <div class="section" id="ops-console-detail-section">
      <h2>Ops Console 詳細</h2>
      <div class="note">lineUserId: <span id="ops-console-detail-line-user-id">-</span></div>
      <div class="note" id="ops-console-detail-error"></div>
      <div>recommendedNextAction: <span id="ops-console-detail-recommended">-</span></div>
      <div>allowedNextActions: <span id="ops-console-detail-allowed">-</span></div>
      <div>readiness:</div>
      <pre id="ops-console-detail-readiness">-</pre>
      <div>opsState:</div>
      <pre id="ops-console-detail-ops-state">-</pre>
      <div>latestDecisionLog:</div>
      <pre id="ops-console-detail-latest-decision">-</pre>
      <div>userStateSummary:</div>
      <pre id="ops-console-detail-user-summary">-</pre>
      <div>memberSummary:</div>
      <pre id="ops-console-detail-member-summary">-</pre>

      <h3>Ops Decision Submit</h3>
      <div class="note">allowedNextActions のみ選択可。</div>
      <div class="note">
        nextAction:
        <select id="ops-decision-action"></select>
        failure_class:
        <select id="ops-decision-failure-class">
          <option value="PASS">PASS</option>
          <option value="ENV">ENV</option>
          <option value="IMPL">IMPL</option>
          <option value="CONFIG">CONFIG</option>
          <option value="UNKNOWN" selected>UNKNOWN</option>
        </select>
      </div>
      <div class="note">
        reasonCode: <input type="text" id="ops-decision-reason-code" />
        stage: <input type="text" id="ops-decision-stage" />
      </div>
      <div class="note">
        note: <input type="text" id="ops-decision-note" />
        <button class="btn" id="ops-decision-submit">submit</button>
      </div>
      <pre id="ops-decision-result">-</pre>
    </div>

    <div class="section">
      <h2>memberNumber 未入力（14日超）</h2>
      <div class="note" id="member-stale-count"></div>
      <table>
        <thead>
          <tr>
            <th>lineUserId</th>
            <th>createdAt</th>
            <th>daysSinceCreated</th>
          </tr>
        </thead>
        <tbody id="member-stale-rows"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Last reviewed</h2>
      <div class="note">手動入力のみ（閲覧や集計では更新しない）</div>
      <div>At: <span id="ops-review-at">-</span></div>
      <div>By: <span id="ops-review-by">-</span></div>
    </div>

    <div class="section" id="implementation-targets">
      <h2>Implementation Targets</h2>
      <div class="note">READ ONLY（参照のみ）</div>
      <table>
        <thead>
          <tr>
            <th>id</th>
            <th>name</th>
            <th>tag</th>
            <th>status</th>
          </tr>
        </thead>
        <tbody id="implementation-targets-rows"></tbody>
      </table>
    </div>

    <script>
      let opsConsoleListCache = [];
      let opsConsoleDetailCache = null;
      let selectedOpsConsoleLineUserId = null;

      function clearChildren(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }

      function setText(node, value) {
        if (!node) return;
        node.textContent = value === undefined || value === null ? '-' : String(value);
      }

      function formatJson(value) {
        if (value === undefined || value === null) return '-';
        return JSON.stringify(value, null, 2);
      }

      function buildRangeQuery(prefix) {
        const from = document.getElementById(`${prefix}-from`).value;
        const to = document.getElementById(`${prefix}-to`).value;
        const params = new URLSearchParams();
        if (from) params.set('from', from);
        if (to) params.set('to', to);
        const qs = params.toString();
        return qs ? `?${qs}` : '';
      }

      function buildUsersQuery() {
        const params = new URLSearchParams();
        const from = document.getElementById('users-from').value;
        const to = document.getElementById('users-to').value;
        if (from) params.set('from', from);
        if (to) params.set('to', to);

        if (document.getElementById('filter-needsAttention').checked) {
          params.set('needsAttention', '1');
        }
        if (document.getElementById('filter-stale').checked) {
          params.set('stale', '1');
        }
        if (document.getElementById('filter-unreviewed').checked) {
          params.set('unreviewed', '1');
        }
        const reviewAgeDays = document.getElementById('filter-reviewAgeDays').value;
        if (reviewAgeDays) {
          params.set('reviewAgeDays', reviewAgeDays);
        }

        const qs = params.toString();
        return qs ? `?${qs}` : '';
      }

      function hydrateUsersFilters() {
        const params = new URLSearchParams(location.search);
        const from = params.get('from');
        const to = params.get('to');
        if (from) document.getElementById('users-from').value = from;
        if (to) document.getElementById('users-to').value = to;

        document.getElementById('filter-needsAttention').checked = params.get('needsAttention') === '1';
        document.getElementById('filter-stale').checked = params.get('stale') === '1';
        document.getElementById('filter-unreviewed').checked = params.get('unreviewed') === '1';
        const reviewAgeDays = params.get('reviewAgeDays');
        if (reviewAgeDays) document.getElementById('filter-reviewAgeDays').value = reviewAgeDays;
      }

      function syncUsersQueryToUrl() {
        const params = new URLSearchParams(location.search);
        const from = document.getElementById('users-from').value;
        const to = document.getElementById('users-to').value;
        if (from) params.set('from', from); else params.delete('from');
        if (to) params.set('to', to); else params.delete('to');
        const lineUserId = params.get('lineUserId');
        if (lineUserId) params.set('lineUserId', lineUserId);

        const needsAttention = document.getElementById('filter-needsAttention').checked;
        const stale = document.getElementById('filter-stale').checked;
        const unreviewed = document.getElementById('filter-unreviewed').checked;
        const reviewAgeDays = document.getElementById('filter-reviewAgeDays').value;

        if (needsAttention) params.set('needsAttention', '1'); else params.delete('needsAttention');
        if (stale) params.set('stale', '1'); else params.delete('stale');
        if (unreviewed) params.set('unreviewed', '1'); else params.delete('unreviewed');
        if (reviewAgeDays) params.set('reviewAgeDays', reviewAgeDays); else params.delete('reviewAgeDays');

        const qs = params.toString();
        const nextUrl = qs ? `${location.pathname}?${qs}` : location.pathname;
        history.replaceState(null, '', nextUrl);
      }

      async function loadUsers() {
        const res = await fetch(`/api/phase5/ops/users-summary${buildUsersQuery()}`);
        const data = await res.json();
        const rows = document.getElementById('users-rows');
        const note = document.getElementById('user-summary-note');
        renderReview(data.review);
        if (!data.ok) {
          rows.innerHTML = '<tr><td colspan="9">error</td></tr>';
          return;
        }
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="9">no data</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.lineUserId}</td>
            <td>${item.hasMemberNumber ? 'あり' : 'なし'}</td>
            <td>${item.checklistCompleted}/${item.checklistTotal}</td>
            <td>${item.stale ? 'Yes' : 'No'}</td>
            <td>${item.needsAttention ? 'Yes' : 'No'}</td>
            <td>${item.opsReviewLastReviewedAt || '-'}</td>
            <td>${item.opsReviewLastReviewedBy || '-'}</td>
            <td>${item.lastActionAt || '-'}</td>
            <td><button class="btn" data-review="${item.lineUserId}">Reviewed</button></td>
          </tr>
        `).join('');

        rows.querySelectorAll('button[data-review]').forEach((btn) => {
          btn.addEventListener('click', async (event) => {
            const lineUserId = event.currentTarget.getAttribute('data-review');
            if (!lineUserId) return;
            await fetch('/api/phase5/admin/users/review', {
              method: 'POST',
              headers: { 'content-type': 'application/json; charset=utf-8' },
              body: JSON.stringify({ lineUserId })
            });
            await loadUsers();
          });
        });

        const params = new URLSearchParams(location.search);
        const lineUserId = params.get('lineUserId');
        if (!lineUserId) {
          note.textContent = 'lineUserId を指定すると個別の状態サマリを表示します';
          return;
        }
        const summaryRes = await fetch(`/api/phase5/state/summary?lineUserId=${encodeURIComponent(lineUserId)}`);
        const summary = await summaryRes.json();
        if (summary.ok && summary.item) {
          const item = summary.item;
          note.textContent = `summary: ${item.lineUserId} / memberNumber: ${item.hasMemberNumber ? 'あり' : 'なし'} / checklist: ${item.checklistCompleted}/${item.checklistTotal} / lastActionAt: ${item.lastActionAt || '-'}`;
        } else {
          note.textContent = 'summary: unavailable';
        }
      }

      async function loadNotifications() {
        const res = await fetch(`/api/phase5/ops/notifications-summary${buildRangeQuery('notifications')}`);
        const data = await res.json();
        const rows = document.getElementById('notifications-rows');
        if (!data.ok) {
          rows.innerHTML = '<tr><td colspan="6">error</td></tr>';
          return;
        }
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="6">no data</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.notificationId}</td>
            <td>${item.sentAt || '-'}</td>
            <td>${item.openCount}</td>
            <td>${item.clickCount}</td>
            <td>${item.lastReactionAt || '-'}</td>
            <td><button class="btn" disabled>詳細を見る</button></td>
          </tr>
        `).join('');
      }

      async function loadStaleMemberNumber() {
        const res = await fetch('/api/phase5/ops/member-number-stale');
        const data = await res.json();
        const countEl = document.getElementById('member-stale-count');
        const rows = document.getElementById('member-stale-rows');
        if (!data.ok) {
          countEl.textContent = 'error';
          rows.innerHTML = '<tr><td colspan="3">error</td></tr>';
          return;
        }
        countEl.textContent = `count: ${data.count}`;
        if (!data.items.length) {
          rows.innerHTML = '<tr><td colspan="3">none</td></tr>';
          return;
        }
        rows.innerHTML = data.items.map((item) => `
          <tr>
            <td>${item.lineUserId}</td>
            <td>${item.createdAt || '-'}</td>
            <td>${item.daysSinceCreated}</td>
          </tr>
        `).join('');
      }

      function renderReview(review) {
        const atEl = document.getElementById('ops-review-at');
        const byEl = document.getElementById('ops-review-by');
        if (!atEl || !byEl) return;
        if (!review || !review.lastReviewedAt || !review.lastReviewedBy) {
          atEl.textContent = '-';
          byEl.textContent = '-';
          return;
        }
        atEl.textContent = review.lastReviewedAt;
        byEl.textContent = review.lastReviewedBy;
      }

      async function loadImplementationTargets() {
        const res = await fetch('/admin/implementation-targets');
        const rows = document.getElementById('implementation-targets-rows');
        const data = await res.json();
        if (!Array.isArray(data)) {
          rows.innerHTML = '<tr><td colspan="4">error</td></tr>';
          return;
        }
        if (!data.length) {
          rows.innerHTML = '<tr><td colspan="4">no data</td></tr>';
          return;
        }
        rows.innerHTML = data.map((item) => `
          <tr>
            <td>${item.id}</td>
            <td>${item.name || '-'}</td>
            <td>${item.tag || '-'}</td>
            <td>${item.status || '-'}</td>
          </tr>
        `).join('');
      }

      async function fetchOpsConsoleList(limit) {
        const params = new URLSearchParams();
        if (limit) params.set('limit', String(limit));
        const qs = params.toString();
        const res = await fetch(`/api/phase26/ops-console/list${qs ? `?${qs}` : ''}`);
        return res.json();
      }

      async function fetchOpsConsoleDetail(lineUserId) {
        const res = await fetch(`/api/phase25/ops/console?lineUserId=${encodeURIComponent(lineUserId)}`);
        return res.json();
      }

      async function submitOpsDecisionRequest(payload) {
        const res = await fetch('/api/phase25/ops/decision', {
          method: 'POST',
          headers: { 'content-type': 'application/json; charset=utf-8' },
          body: JSON.stringify(payload)
        });
        return res.json();
      }

      function renderOpsConsoleList(items) {
        const rows = document.getElementById('ops-console-list-rows');
        clearChildren(rows);
        if (!items.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.textContent = 'no data';
          tr.appendChild(td);
          rows.appendChild(tr);
          return;
        }
        items.forEach((item) => {
          const tr = document.createElement('tr');
          const cells = [
            item.lineUserId,
            item.readiness && item.readiness.status ? item.readiness.status : '-',
            item.recommendedNextAction || '-',
            Array.isArray(item.allowedNextActions) ? item.allowedNextActions.join(', ') : '-',
            item.opsState && item.opsState.nextAction ? item.opsState.nextAction : '-',
            item.latestDecisionLog ? JSON.stringify(item.latestDecisionLog) : '-'
          ];
          cells.forEach((value) => {
            const td = document.createElement('td');
            td.textContent = value;
            tr.appendChild(td);
          });
          const actionTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = '詳細';
          btn.dataset.lineUserId = item.lineUserId;
          btn.addEventListener('click', async (event) => {
            const targetId = event.currentTarget.dataset.lineUserId;
            if (!targetId) return;
            await loadOpsConsoleDetail(targetId);
          });
          actionTd.appendChild(btn);
          tr.appendChild(actionTd);
          rows.appendChild(tr);
        });
      }

      function updateDecisionActionOptions(detail) {
        const select = document.getElementById('ops-decision-action');
        clearChildren(select);
        const readinessStatus = detail && detail.readiness ? detail.readiness.status : null;
        let allowed = Array.isArray(detail && detail.allowedNextActions) ? detail.allowedNextActions.slice() : [];
        if (readinessStatus === 'NOT_READY') {
          allowed = ['STOP_AND_ESCALATE'];
        }
        if (!allowed.length) {
          allowed = ['STOP_AND_ESCALATE'];
        }
        allowed.forEach((action) => {
          const option = document.createElement('option');
          option.value = action;
          option.textContent = action;
          select.appendChild(option);
        });
        if (detail && detail.recommendedNextAction && allowed.includes(detail.recommendedNextAction)) {
          select.value = detail.recommendedNextAction;
        }
      }

      function renderOpsConsoleDetail(detail) {
        setText(document.getElementById('ops-console-detail-line-user-id'), detail.lineUserId || '-');
        setText(document.getElementById('ops-console-detail-recommended'), detail.recommendedNextAction || '-');
        setText(
          document.getElementById('ops-console-detail-allowed'),
          Array.isArray(detail.allowedNextActions) ? detail.allowedNextActions.join(', ') : '-'
        );
        setText(document.getElementById('ops-console-detail-readiness'), formatJson(detail.readiness));
        setText(document.getElementById('ops-console-detail-ops-state'), formatJson(detail.opsState));
        setText(document.getElementById('ops-console-detail-latest-decision'), formatJson(detail.latestDecisionLog));
        setText(document.getElementById('ops-console-detail-user-summary'), formatJson(detail.userStateSummary));
        setText(document.getElementById('ops-console-detail-member-summary'), formatJson(detail.memberSummary));
        updateDecisionActionOptions(detail);
      }

      async function loadOpsConsoleList() {
        const note = document.getElementById('ops-console-list-note');
        const errorEl = document.getElementById('ops-console-list-error');
        setText(errorEl, '');
        const limitValue = document.getElementById('ops-console-limit').value;
        const limit = limitValue ? Number(limitValue) : 20;
        try {
          const data = await fetchOpsConsoleList(limit);
          if (!data || !data.ok) {
            setText(errorEl, 'error');
            renderOpsConsoleList([]);
            return;
          }
          opsConsoleListCache = Array.isArray(data.items) ? data.items : [];
          const pageInfoText = data.pageInfo ? JSON.stringify(data.pageInfo) : '-';
          note.textContent = `serverTime: ${data.serverTime || '-'} / pageInfo: ${pageInfoText} / nextPageToken: ${data.nextPageToken || '-'}`;
          renderOpsConsoleList(opsConsoleListCache);
        } catch (err) {
          setText(errorEl, 'error');
          renderOpsConsoleList([]);
        }
      }

      async function loadOpsConsoleDetail(lineUserId) {
        const errorEl = document.getElementById('ops-console-detail-error');
        setText(errorEl, '');
        selectedOpsConsoleLineUserId = lineUserId;
        setText(document.getElementById('ops-console-detail-line-user-id'), lineUserId || '-');
        try {
          const detail = await fetchOpsConsoleDetail(lineUserId);
          if (!detail || !detail.ok) {
            setText(errorEl, 'error');
            return;
          }
          opsConsoleDetailCache = detail;
          renderOpsConsoleDetail(detail);
        } catch (err) {
          setText(errorEl, 'error');
        }
      }

      async function handleSubmitOpsDecision() {
        const resultEl = document.getElementById('ops-decision-result');
        setText(resultEl, '');
        const lineUserId = selectedOpsConsoleLineUserId;
        if (!lineUserId) {
          setText(resultEl, 'lineUserId not selected');
          return;
        }
        const nextAction = document.getElementById('ops-decision-action').value;
        const failureClass = document.getElementById('ops-decision-failure-class').value;
        const reasonCode = document.getElementById('ops-decision-reason-code').value;
        const stage = document.getElementById('ops-decision-stage').value;
        const note = document.getElementById('ops-decision-note').value;
        const payload = {
          lineUserId,
          decision: {
            nextAction,
            failure_class: failureClass,
            reasonCode: reasonCode || null,
            stage: stage || null,
            note: note || ''
          }
        };
        try {
          const result = await submitOpsDecisionRequest(payload);
          setText(resultEl, formatJson(result));
          if (result && result.ok) {
            await loadOpsConsoleDetail(lineUserId);
            await loadOpsConsoleList();
          }
        } catch (err) {
          setText(resultEl, 'error');
        }
      }

      document.getElementById('users-apply').addEventListener('click', () => {
        syncUsersQueryToUrl();
        loadUsers().catch(() => {});
      });
      document.getElementById('notifications-apply').addEventListener('click', () => {
        loadNotifications().catch(() => {});
      });
      document.getElementById('ops-console-refresh').addEventListener('click', () => {
        loadOpsConsoleList().catch(() => {});
      });
      document.getElementById('ops-decision-submit').addEventListener('click', () => {
        handleSubmitOpsDecision().catch(() => {});
      });

      hydrateUsersFilters();
      Promise.all([
        loadUsers(),
        loadNotifications(),
        loadStaleMemberNumber(),
        loadImplementationTargets(),
        loadOpsConsoleList()
      ]).catch(() => {
        document.getElementById('users-rows').innerHTML = '<tr><td colspan="9">error</td></tr>';
        document.getElementById('notifications-rows').innerHTML = '<tr><td colspan="6">error</td></tr>';
        document.getElementById('member-stale-rows').innerHTML = '<tr><td colspan="3">error</td></tr>';
        document.getElementById('implementation-targets-rows').innerHTML = '<tr><td colspan="4">error</td></tr>';
      });
    </script>
  </body>
</html>
