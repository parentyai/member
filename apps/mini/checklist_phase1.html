<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checklist (Phase1)</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; margin: 24px; }
    .item { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
    .meta { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Checklist (Phase1)</h1>
  <div id="status"></div>
  <div id="list"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const lineUserId = params.get('lineUserId');
    const step = params.get('step');
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');

    if (!lineUserId || !step) {
      statusEl.textContent = 'lineUserId/step required';
    } else {
      fetch(`/api/phase1/mini/checklist?lineUserId=${encodeURIComponent(lineUserId)}&step=${encodeURIComponent(step)}`)
        .then((res) => res.json())
        .then((data) => {
          if (!data.ok) {
            statusEl.textContent = data.error || 'error';
            return;
          }
          const items = data.items || [];
          if (!items.length) {
            statusEl.textContent = 'no items';
            return;
          }
          items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = Boolean(item.completedAt);
            checkbox.addEventListener('change', () => {
              fetch('/api/phase1/mini/checklist/toggle', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({
                  lineUserId,
                  itemKey: item.itemId,
                  done: checkbox.checked
                })
              }).catch(() => {
                checkbox.checked = !checkbox.checked;
              });
            });
            const label = document.createElement('span');
            label.textContent = item.title || item.itemId;
            const meta = document.createElement('span');
            meta.className = 'meta';
            meta.textContent = `linkRegistryId=${item.linkRegistryId}`;
            row.appendChild(checkbox);
            row.appendChild(label);
            row.appendChild(meta);
            listEl.appendChild(row);
          });
        })
        .catch(() => {
          statusEl.textContent = 'fetch error';
        });
    }
  </script>
</body>
</html>
