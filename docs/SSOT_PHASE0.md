# SSOT Snapshot (Phase0)
- SSOT Version: v0.2
- Updated: TODO (from source)
- Source: User prompt (Canvas)

# Phase 0 統合仕様書（改訂版 v0.2）

> 目的：Eメール中心の公式連絡を、LINE（ミニアプリ＋メッセージ）へ実務的に置換し、
> 「見逃さない・動ける・管理が回る」状態を作る。

---

## 0. 用語（Phase0の範囲で固定）
- **LINE識別子**：LINE userId（当方の一次キー）
- **会員番号**：ユーザー任意入力（真正性保証なし）
- **通知（Nudge）**：短文で“理由”と“次の一歩”を伝える
- **詳細（Detail）**：原則リンク先（提供元Web）に置く。ミニアプリ内に長文は置かない

---

## 1. 目的・成功定義（Phase 0）
### 1.1 目的
- 赴任者向けの各種連絡をLINEに集約し、Eメール依存を削る
- ユーザーに「連絡はLINEで来る」習慣を作り、重要連絡の見逃しを減らす
- 管理側の配信作業・個別対応（メール送付、再送、問い合わせ誘導）を減らす

### 1.2 成功定義（KGI）
- 赴任者の**90%以上**がLINEで公式連絡を受信可能
- 従来Eメールで送付していた通知の**70%以上**をLINEに移行
- 通知開封（既読）率：Eメール平均50% → LINEで**80%以上**
- 重要通知の確認率（リンククリック or ミニアプリ内確認アクション）：**30%以上**（初期目標）
- アンケートで「情報を受け取りやすくなった」**70%以上**

---

## 2. 体験設計（UX要件）

### 2.1 UX原則（Phase0の“奥ゆかしいが気の利いた”挙動）
1) **短い理由**：なぜ今この通知か（背景）を1行で説明  
2) **軽い圧**：見ないと損する可能性（手戻り・遅延・機会損失）を示唆  
3) **次の一歩は1つ**：CTAは必ず1個  
4) **詳細は外**：詳細説明は公式リンクへ退避  
5) **シナリオ前提**：通知は常に「赴任シナリオ」に基づいて出す  

### 2.2 赴任シナリオ設計（Phase0で扱う範囲）
本システムでは、赴任者を以下の**代表シナリオ**に分類し、ステップ通知の内容と順序を切り替える。

#### シナリオA：単身赴任（短期）
- 特徴：準備期間が短い、生活設営を最小化したい
- 重視事項：住居確定スピード、通信、銀行

#### シナリオB：家族帯同（子どもなし）
- 特徴：住居・保険・車の検討が中心
- 重視事項：住宅条件、生活インフラ

#### シナリオC：家族帯同（子どもあり）
- 特徴：検討事項が最も多い
- 重視事項：学区、学校、医療、住居

#### シナリオD：着任済み（途中参加）
- 特徴：既に一部手続き完了
- 重視事項：抜け漏れ補完、生活安定化

※ Phase0ではシナリオは**固定分類**とし、AI推定は行わない

### 2.3 属性マトリクス（チェックリスト切替条件）

| 属性カテゴリ | 値例 | チェックリスト影響 |
|---|---|---|
| 世帯構成 | 単身 / 家族 | 学校・医療項目の有無 |
| 子ども | あり / なし | 学区・教育項目 |
| 着任地 | 州・都市 | 地域特有手続き・リンク |
| 赴任時期 | 出発前 / 到着直後 | ステップ順序 |
| 会員状態 | GUEST / MEMBER | 特典導線表示有無 |

### 2.4 ステップ通知の構成（共通フォーマット）
- ステップID  
- 対応シナリオ（A/B/C/D）  
- 発火条件（時期・状態）  
- 通知テンプレ（短文）  
- チェックリスト項目（リンク集）  
- 次ステップID  

### 2.5 チェックリスト仕様
- チェックリストは**固定テンプレ＋属性差分**で構成
- 表示は「今やるべき3〜5項目」に限定
- 完了/未完了は自己申告（Phase0）
- 完了操作は行動ログとして保存

### 2.6 代表シナリオ別チェックリスト実例

#### シナリオA：単身NY赴任

**出発3か月前**
- 住居エリアの候補整理（治安・通勤目安）
- 米国携帯プランの基礎把握
- 渡航スケジュール確認（入国日・仮滞在）

**出発1か月前**
- 住居探しの進め方を確認（内見・契約フロー）
- 必要書類リスト確認（パスポート/ビザ等）
- 米国銀行口座の基礎知識確認

**出発週**
- 初日〜1週目の行動チェック（SIM/交通/生活必需品）
- 仮滞在先からの通勤確認
- 緊急連絡先の確認

**到着後1週**
- 住居契約の最終確認
- 携帯・銀行の利用開始確認
- 生活インフラ（電気/ネット）の初期設定確認

---

#### シナリオC：家族帯同（子どもあり）CA赴任

**出発3か月前**
- 学区・学校制度の基本確認
- 住居条件の優先順位整理（学区/通勤/治安）
- 医療・保険制度の基礎把握

**出発1か月前**
- 学校手続きに必要な書類確認
- 住居内見・契約準備
- 車社会前提の生活準備確認

**出発週**
- 到着後1週目の家族動線確認（通学/通勤）
- 医療機関・緊急先の確認
- 仮住まいでの生活準備

**到着後1週**
- 学校・学区手続きの進捗確認
- 住居入居後の生活立ち上げ（電気/水/ネット）
- 車・保険関連の初期対応確認

---

## 3. 通知コピー完全サンプル（Phase0）

> ルール再掲：短文／理由明示／CTA1つ／詳細は公式リンク

### シナリオA：単身NY赴任

**出発3か月前**
- 件名：NY赴任前に一度だけ確認を  
- 本文：住まい探しは早めに全体像を掴むと、後の選択肢が広がります。今の段階で知っておくと無駄が減ります。  
- CTA：住居探しの流れを見る  

**出発1か月前**
- 件名：渡航直前で慌てないために  
- 本文：渡航書類や現地初期手続きで、直前に詰まりやすい点があります。念のため一度目を通しておくと安心です。  
- CTA：必要書類を確認する  

**出発週**
- 件名：到着後1週間が楽になります  
- 本文：NY到着直後に必要になる行動をまとめています。初日のバタつきを避けるため、今のうちに確認しておくのがおすすめです。  
- CTA：到着後チェックを見る  

**到着後1週**
- 件名：生活立ち上げの最終確認  
- 本文：住居・通信・銀行まわりで、ここまで済んでいれば一段落です。漏れがないかだけ確認してみてください。  
- CTA：生活チェックリストを見る  

---

### シナリオC：家族帯同（子どもあり）CA赴任

**出発3か月前**
- 件名：学区と住まい、先に全体像を  
- 本文：学校・学区は住まい選びに直結します。後から変更が難しい点なので、今の段階で整理しておくと安心です。  
- CTA：学区と住居の関係を見る  

**出発1か月前**
- 件名：学校手続きで詰まりやすい点  
- 本文：CAでは学校関連書類で手戻りが起きやすいです。出発前に必要書類を一度確認しておくとスムーズです。  
- CTA：学校書類を確認する  

**出発週**
- 件名：到着直後の家族動線を整理  
- 本文：通学・通勤・生活動線を先に把握しておくと、最初の1週間がかなり楽になります。  
- CTA：到着後の動線を見る  

**到着後1週**
- 件名：生活が落ち着く前の確認  
- 本文：学校・住居・インフラの初期対応で、見落としやすい項目があります。一度だけチェックしてみてください。  
- CTA：初期対応を確認する  

---

## 4. 管理画面 操作フロー（Phase0）

### 4.1 利用者ロール
- 運用担当（主）：通知作成・配信
- 管理責任者：承認・緊急停止

### 4.2 通知配信の基本フロー
1. 管理画面にログイン  
2. 「通知作成」をクリック  
3. 通知テンプレを選択（シナリオ×ブロック）  
4. 文言を必要に応じて微調整（定型内）  
5. リンクURLを入力（公式ページ）  
6. 配信対象を選択（シナリオ／時期／地域）  
7. プレビュー確認  
8. テスト送信（任意）  
9. 配信予約 or 即時配信  

### 4.3 配信後の確認
- ダッシュボードで以下を確認：
  - 送達数
  - 既読率
  - クリック率
- 想定より低い場合：
  - 再送は行わず、次ステップで調整（Phase0原則）

### 4.4 緊急時対応
- 誤配信・リンク不備時：
  - 管理責任者が「配信停止」をクリック
  - 必要に応じて訂正版を新規通知として配信
- すべての操作は監査ログに記録

---

## 5. 補足（Phase0運用原則）
- 通知は“出し過ぎない”（週N回上限）
- 再送は原則行わない
- 迷ったら「送らない」を選ぶ
- 詳細説明は必ず公式リンクに集約

※ 本仕様はPhase0専用。AI最適化・自動判断は含まない。

---

# 6. 実装仕様パッケージ（VS Code GPT向け / Phase0 完全実装指示）

> 目的：本章をそのままVS Code常駐GPTへ貼り付ければ、Phase0（v0.2）を迷いなく実装できる状態にする。
> 注意：仕様の勝手な拡張は禁止。迷ったら「送らない」「保存しない」「リンク先に逃がす」。

---

## 6.1 完了条件（ACCEPTANCE / 受入条件）
以下がすべてYESならPhase0実装完了。

### A. LINE
- LINE公式アカウントから特定ユーザーへ通知（push）が送れる
- Webhookでイベント受信し、LINE userIdを取得・保存できる
- リッチメニュー4枠が動作し、ミニアプリ/外部リンクへ遷移できる
- 登録直後の初回メッセージが1回だけ自動送信される

### B. ミニアプリ（超最小）
- LINE userIdで自動識別（ID/Passなし）
- 画面①：公式連絡一覧（通知履歴：未読/既読）
- 画面②：今やること（チェックリスト3〜5項目：シナリオ×ステップで切替）
- 各通知/項目はCTA1つで公式リンクへ遷移（クリック計測あり）

### C. 管理画面（Opsが1人で回せる）
- 通知作成（件名/本文/CTA/公式リンク）
- シナリオ×ステップ選択（A or C / 3mo,1mo,week,after1w）
- 配信条件（全体/地域/会員番号入力済のみ）
- プレビュー→テスト送信→即時配信 or 予約
- 配信履歴（送達/既読/クリック）
- Kill Switch（配信停止ON/OFF、管理責任者のみ）
- 監査ログ（誰が何をいつ）

### D. 運用安全
- リンク未入力は保存不可
- Link Registry（登録/ヘルスチェック/警告）
- WARNリンクは通知に紐付けられない（または強警告でブロック）
- 監査ログは削除不可

---

## 6.2 仕様固定（これ以外は作らない）
- 認証：ID/Pass発行しない。LINE userIdのみ。
- 会員番号：ユーザー任意入力。真正性保証なし。VERIFIEDは作らない。
- AI：文章生成/最適化/推定は実装しない。
- 再送：Phase0原則しない（運用で次ステップ調整）。
- 個人情報：最小。心理/嗜好/推定属性は保存しない。

---

## 6.3 情報設計（固定）
### 6.3.1 シナリオ（Phase0はA/Cのみ実装）
- A: 単身NY赴任
- C: 家族（子あり）CA赴任
※ B/Dは将来枠として定義してよいが、Phase0 UIには出さない。

### 6.3.2 ステップ（4ブロック固定）
- 3mo（出発3か月前）
- 1mo（出発1か月前）
- week（出発週）
- after1w（到着後1週）

### 6.3.3 リッチメニュー（4枠固定）
1) 📩 公式連絡・重要通知 → ミニアプリ/通知一覧
2) ✅ 赴任チェックリスト → ミニアプリ/チェックリスト
3) 📖 よくある質問 → 公式FAQ（外部）
4) ✉️ 問い合わせ・相談 → 公式問い合わせ（外部）

### 6.3.4 初回メッセージ（登録直後1回）
「公式からのご案内はすべてこちらのLINEでお送りします。重要なお知らせは『公式連絡』からご確認ください。」

---

## 6.4 通知コピー（Phase0データとして登録）
> すべて「公式リンク（Detail）」1つ必須。リンクは Link Registry から選択。

### シナリオA：単身NY赴任
- 3mo：件名「NY赴任前に一度だけ確認を」/ 本文「住まい探しは早めに全体像を掴むと、後の選択肢が広がります。今の段階で知っておくと無駄が減ります。」/ CTA「住居探しの流れを見る」
- 1mo：件名「渡航直前で慌てないために」/ 本文「渡航書類や現地初期手続きで、直前に詰まりやすい点があります。念のため一度目を通しておくと安心です。」/ CTA「必要書類を確認する」
- week：件名「到着後1週間が楽になります」/ 本文「NY到着直後に必要になる行動をまとめています。初日のバタつきを避けるため、今のうちに確認しておくのがおすすめです。」/ CTA「到着後チェックを見る」
- after1w：件名「生活立ち上げの最終確認」/ 本文「住居・通信・銀行まわりで、ここまで済んでいれば一段落です。漏れがないかだけ確認してみてください。」/ CTA「生活チェックリストを見る」

### シナリオC：家族帯同（子どもあり）CA赴任
- 3mo：件名「学区と住まい、先に全体像を」/ 本文「学校・学区は住まい選びに直結します。後から変更が難しい点なので、今の段階で整理しておくと安心です。」/ CTA「学区と住居の関係を見る」
- 1mo：件名「学校手続きで詰まりやすい点」/ 本文「CAでは学校関連書類で手戻りが起きやすいです。出発前に必要書類を一度確認しておくとスムーズです。」/ CTA「学校書類を確認する」
- week：件名「到着直後の家族動線を整理」/ 本文「通学・通勤・生活動線を先に把握しておくと、最初の1週間がかなり楽になります。」/ CTA「到着後の動線を見る」
- after1w：件名「生活が落ち着く前の確認」/ 本文「学校・住居・インフラの初期対応で、見落としやすい項目があります。一度だけチェックしてみてください。」/ CTA「初期対応を確認する」

---

## 6.5 Link Registry（公式リンク台帳：必須）
### 6.5.1 目的
- 詳細は提供元Webへ退避し、当方は入口に徹する（責任分界）
- 死んだリンクを配信前に検出し、事故を防ぐ

### 6.5.2 登録項目
- title
- url
- expiry（任意）
- tags（scenario/step/topic）
- lastHealth：{checkedAt, statusCode, state:'OK'|'WARN'}

### 6.5.3 動作
- 管理画面でCRUD
- 手動ヘルスチェック（直近HTTPステータス保存）
- WARNは通知作成時に強警告（または保存不可）
- 通知はURL直書き禁止。registryId参照で紐付け

---

## 6.6 データモデル（Firestore想定 / 最小）
### users/{lineUserId}
- createdAt
- scenarioKey: 'A'|'C'
- stepKey: '3mo'|'1mo'|'week'|'after1w'
- memberNumber: string|null
- memberCardAsset: {type:'image'|'pdf', storagePath, uploadedAt}|null

### notifications/{notificationId}
- title, body, ctaText, linkRegistryId
- scenarioKey, stepKey
- target: {all?:boolean, region?:string, membersOnly?:boolean}
- status: 'draft'|'scheduled'|'sent'|'stopped'
- scheduledAt|null, sentAt|null
- createdBy, createdAt

### notification_deliveries/{deliveryId}
- notificationId, lineUserId
- sentAt, delivered:boolean
- readAt|null
- clickAt|null

### link_registry/{linkId}
- title, url, expiry|null, tags
- lastHealth:{checkedAt, statusCode, state:'OK'|'WARN'}

### audit_logs/{logId}
- actor, action, entityType, entityId
- payloadSummary
- createdAt

### system_flags/phase0
- killSwitch:boolean

---

## 6.7 API設計（最小）
- POST /webhook/line  （LINEイベント受信）
- POST /admin/notifications  （作成）
- POST /admin/notifications/:id/test-send  （テスト送信）
- POST /admin/notifications/:id/send  （即時配信 or 予約）
- GET  /admin/notifications  （履歴一覧）
- POST /admin/kill-switch  （ON/OFF：管理責任者のみ）
- CRUD /admin/link-registry  （登録/一覧/ヘルスチェック）
- POST /track/click  （クリック記録→リダイレクト）

備考：既読イベントが取得困難な場合、ミニアプリで通知を開いた時点で readAt を代替記録して良い。

---

## 6.8 画面仕様（ミニアプリ / 管理画面）
### ミニアプリ
- /inbox（通知一覧）
- /checklist（今やること：3〜5項目）
- /member（会員番号入力、会員カード画像/PDFアップロード）

### 管理画面
- /dashboard（KPI）
- /notifications/new（作成）
- /notifications（履歴）
- /links（Link Registry）
- /audit（監査ログ）
- /settings（Kill Switch）

---

## 6.9 実装順序（厳守）
1) DBスキーマCRUD
2) LINE webhookでuserId取得→users作成
3) push送信（テスト送信）
4) 管理画面：通知作成→テスト送信→配信
5) ミニアプリ：inbox/checklist表示
6) クリック計測→リダイレクト
7) Kill Switch / 監査ログ / Link Registryヘルス

---

## 6.10 最低限テスト（Phase0合格ライン）
- webhook受信でusersが作られる
- 通知作成→テスト送信が成功
- 配信で対象ユーザーにdeliveryが作られる
- クリックでclickAtが記録
- Kill Switch ONで配信が拒否
- WARNリンクが通知に紐付けできない（または強警告）

---

## 6.11 出力物（実装完了時に必須で残す）
- 実装したファイル一覧
- 起動手順（ENV含む）
- 1回のE2E手順（管理画面→テスト送信→ミニアプリ確認）
- ロールバック手順（killSwitch、デプロイ戻し）
- 既知の制限（Phase0範囲）

---

# 7. 実装ガバナンス（Todo / Playbook / ルール / SSOT）

> 目的：Phase0実装を「迷子・重複・ゴミ増殖」させず、品質と速度を両立させる。
> 方針：SSOT（Single Source of Truth）を固定し、TodoとPlaybookで実行を管理し、ルールで逸脱を機械的に防ぐ。

---

## 7.1 SSOT（唯一の正本）
### 7.1.1 SSOTの範囲
- 本書（Phase 0 統合仕様書 v0.2 + 第6章 実装仕様パッケージ + 第7章 実装ガバナンス）が **Phase0の唯一のSSOT**
- コード・README・メモ等がSSOTと矛盾した場合、SSOTを優先し、コードを修正する

### 7.1.2 SSOT変更ルール（Phase0）
- Phase0実装中は **SSOTの改変を最小化**（原則：追記のみ）
- 変更が必要な場合は以下を必須：
  - 変更理由（バグ/要件誤り/運用事情）
  - 影響範囲（API/DB/UI/運用）
  - ロールバック（戻し方）

---

## 7.2 Todo管理（実装を管理するための単一台帳）
### 7.2.1 Todoファイル（必須）
- `TODO_PHASE0.md`：Phase0スプリントのタスク台帳（唯一）
  - タスクID（P0-###）
  - 目的（Why）
  - 完了条件（Acceptance）
  - 依存関係（DependsOn）
  - 実装箇所（Files）
  - テスト（Tests）

### 7.2.2 Todo運用ルール
- 新規タスク追加は `TODO_PHASE0.md` にのみ追記
- タスク完了は「チェック＋証跡（PR/コミット/ログ）」が必須
- “思いつきの実装”は禁止（必ずタスクIDに紐付け）

---

## 7.3 Playbook（Runbook + Debugbook + Incidentbook）
### 7.3.1 必須Playbook
- `docs/PLAYBOOK_PHASE0_BUILD.md`
  - ローカル起動
  - ENV設定
  - seed投入
  - LINE疎通
- `docs/PLAYBOOK_PHASE0_E2E.md`
  - 管理画面→テスト送信→ミニアプリ確認→クリック計測までの手順
- `docs/PLAYBOOK_PHASE0_DEBUG.md`
  - よくある失敗（署名、権限、ENV、Webhook疎通）
  - エラーコード→原因→対処
- `docs/PLAYBOOK_PHASE0_INCIDENT.md`
  - 誤配信時（Kill Switch）
  - リンク死活（WARN）
  - 監査ログ記録

### 7.3.2 Playbook品質ルール
- Playbookは「誰でも再現できる」手順にする（コマンド・URL・期待結果を明記）
- 変更が入ったら、該当Playbookも同時更新（SSOT矛盾防止）

---

## 7.4 実装ルール（GPT暴走防止のガード）
### 7.4.1 ファイル作成ルール（Allowlist）
- 第1級：`src/` `apps/` `docs/` `scripts/` `tests/` 以外の新規ディレクトリ作成は禁止
- 例外は「理由＋代替案なし」を満たした場合のみ（最小1回）

### 7.4.2 入口・副作用ルール
- サーバ起動入口は `src/index.js` のみ
- import副作用（起動時に勝手にタイマー/送信/seed）は禁止

### 7.4.3 データ・責任分界ルール
- 通知の詳細は必ずLink Registry（公式リンク）に退避
- 通知にURL直書き禁止（registryId参照のみ）
- CTAは1つ（validatorで強制）
- Kill Switch ON時の配信は必ず拒否

---

## 7.5 品質ゲート（CI/テスト/チェックリスト）
### 7.5.1 必須チェック（PR前）
- `npm test`（最低限テスト）
- `npm run lint`（ある場合）
- `scripts/seed_phase0.js` が成功
- E2E（Playbook Phase0 E2E）を最低1回実施

### 7.5.2 PRテンプレ（推奨）
- `.github/PULL_REQUEST_TEMPLATE.md`
  - 目的
  - 変更点
  - 影響範囲
  - テスト結果
  - ロールバック
  - SSOT差分（必要時）

---

## 7.6 SSOT整合のための「決めごと」
- 仕様→実装の対応表は **本書の第6章** が唯一
- 実装中の判断に迷ったら：
  1) 第6章（実装仕様）
  2) 第4章（運用フロー）
  3) 第2章（UX原則）
  の順で決める

---

## 7.7 実装完了の証跡（Deliverables）
- `docs/PLAYBOOK_PHASE0_E2E.md` の手順が、第三者でも通る
- `docs/PLAYBOOK_PHASE0_DEBUG.md` に主要エラーの対処が載っている
- `TODO_PHASE0.md` が全完了（証跡付き）
- 監査ログが機能している（誰が/いつ/何を）
